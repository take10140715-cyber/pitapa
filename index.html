<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiTaPa利用チェックツール v57</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        
        /* スクロールバー */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 印刷用スタイル - A4縦・極限まで高密度化 */
        @media print {
            @page { 
                size: A4 portrait; 
                margin: 5mm; 
            }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact; 
                font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif; 
                width: 100%;
                height: 100%;
            }
            
            /* 印刷時に非表示 */
            .no-print, header, nav, .upload-area, .settings-area, .utility-bar, .user-input-form, .alias-input-form, .info-panel, button, .modal-overlay { 
                display: none !important; 
            }
            
            /* 印刷エリア */
            #root, main, .container { 
                width: 100% !important; 
                max-width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                display: block !important;
                background-color: white !important;
                overflow: visible !important;
            }
            
            .print-area { 
                display: block !important;
                zoom: 0.95; 
            }

            .page-break { 
                page-break-inside: avoid;
                margin-bottom: 5px;
                border-bottom: 1px dashed #888;
                padding-bottom: 5px;
            }
            
            /* テーブルデザイン - 行の高さ圧縮 */
            table { 
                width: 100%; 
                border-collapse: collapse; 
                font-size: 8pt !important; 
                table-layout: fixed; 
            }
            th, td { 
                border: 1px solid #444; 
                padding: 1px 2px !important; 
                word-wrap: break-word; 
                vertical-align: middle;
                line-height: 1.1 !important; 
            }
            th { 
                background-color: #e5e7eb !important; 
                color: #000 !important; 
                font-weight: bold; 
                text-align: center;
                font-size: 8pt !important;
                padding: 1px 0px !important;
                height: 14px !important;
            }
            
            th:nth-child(1) { width: 5%; }   /* 状態 */
            th:nth-child(2) { width: 10%; }  /* 日付 */
            th:nth-child(3) { width: 20%; }  /* 時間 */
            th:nth-child(4) { width: 28%; }  /* 内容 */
            th:nth-child(5) { width: 7%; }   /* 金額 */
            th:nth-child(6) { width: 30%; }  /* 備考 */

            td:nth-child(1) span { 
                font-size: 6pt !important; 
                padding: 0 !important; 
                border: 1px solid #999 !important;
                margin: 0 !important;
                display: inline-block;
                white-space: nowrap;
                line-height: 1;
                transform: scale(0.9);
            }

            td:nth-child(2), td:nth-child(3) { 
                text-align: center; 
                white-space: nowrap; 
                font-family: Arial, sans-serif; 
                font-size: 8pt !important;
                letter-spacing: -0.5px;
            }

            td:nth-child(4), td:nth-child(6) { 
                text-align: left; 
                font-size: 8pt !important; 
                line-height: 1.0 !important;
            }

            td:nth-child(5) { 
                text-align: right; 
                font-family: Arial, sans-serif; 
                font-size: 8pt !important;
            }
            
            tr { height: auto !important; }
            
            .bg-red-50 { background-color: #fff0f0 !important; }
            .bg-blue-50 { background-color: #f0f7ff !important; }
            .text-red-600 { color: #000 !important; font-weight: bold; } 
            
            .shadow-sm { box-shadow: none !important; border: none !important; }
            .rounded-xl { border-radius: 0 !important; border: none !important; }
            
            .result-card { 
                border-bottom: 1px solid #000; 
                margin-bottom: 5px; 
                padding-bottom: 2px; 
            }
            
            /* ヘッダー */
            .result-header { 
                border-bottom: 1px solid #000; 
                margin-bottom: 1px; 
                padding: 1px 0; 
                display: flex;
                flex-wrap: wrap; 
                justify-content: space-between;
                align-items: flex-end;
            }
            .result-header h3 { font-size: 9pt; margin: 0; width: 100%; }
            .result-header .pass-info { font-size: 7pt; color: #333; margin-top: 1px; width: 100%; }
            .result-header .summary-info { font-size: 8pt; margin: 0; margin-left: auto; }
            
            .print-summary-box {
                border: 1px solid #000;
                padding: 2px 5px;
                margin-bottom: 5px;
                font-size: 8pt;
                break-inside: avoid;
            }
            .print-summary-title { font-weight: bold; text-decoration: underline; margin-right: 5px; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const Icons = {
            Upload: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            UploadFile: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Help: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        };

        // --- Components ---

        const AlertBadge = ({ type }) => {
            const styles = {
                holiday: "bg-red-100 text-red-800 border-red-200",
                sunday: "bg-red-100 text-red-800 border-red-200",
                saturday: "bg-blue-100 text-blue-800 border-blue-200",
                route: "bg-yellow-100 text-yellow-800 border-yellow-200",
                bus: "bg-gray-100 text-gray-600",
                unknown: "bg-orange-100 text-orange-800 border-orange-200"
            };
            const labels = {
                holiday: "休日",
                sunday: "日曜",
                saturday: "土曜",
                route: "定期重複",
                bus: "対象外",
                unknown: "駅名不明"
            };
            return (
                <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border mr-2 ${styles[type] || ""}`}>
                    {labels[type]}
                </span>
            );
        };

        const HelpModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay no-print">
                    <div className="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 className="text-xl font-bold text-gray-800">ユーザーマニュアル</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 font-bold text-2xl">×</button>
                        </div>
                        <div className="space-y-4 text-sm text-gray-700">
                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">1. はじめに</h3>
                                <p>このツールは、PiTaPaの利用明細CSVを読み込み、定期区間との重複や休日利用を自動チェックするアプリです。</p>
                            </section>
                            
                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">2. 使い方</h3>
                                <div className="pl-4 space-y-2">
                                    <div>
                                        <h4 className="font-bold">① 社員・定期の登録 (「定期・設定」タブ)</h4>
                                        <ul className="list-disc pl-5">
                                            <li>社員名と定期区間（利用している鉄道会社・路線・区間）を登録します。</li>
                                            <li>発駅と着駅で異なる事業者（例：大阪メトロ～阪急）を設定可能です。</li>
                                            <li className="text-red-600 font-bold">重要: 社員名はCSVの「○○　○○　様ご利用分」の氏名と【一字一句（全角スペース含む）】完全に一致させてください。</li>
                                            <li>例：「山田　太郎」（全角スペースあり）</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-bold">② CSVファイルの読み込み (「CSV取込」タブ)</h4>
                                        <ul className="list-disc pl-5">
                                            <li>PiTaPa倶楽部からダウンロードしたCSVファイルをドラッグ＆ドロップします。</li>
                                            <li>複数のファイルを一度に読み込んだり、フォルダごと指定することも可能です。</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h4 className="font-bold">③ 結果の確認 (「結果確認」タブ)</h4>
                                        <ul className="list-disc pl-5">
                                            <li>画面上部の集計パネルで全体状況を確認します。</li>
                                            <li>各社員のカードで詳細な利用履歴とアラートを確認します。</li>
                                            <li>必要に応じて「結果CSV出力」でデータをダウンロードします。</li>
                                        </ul>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">3. 結果確認画面の見方と操作</h3>
                                <div className="pl-4 space-y-3">
                                    <div>
                                        <h4 className="font-bold border-b border-gray-200 mb-1">上部リストパネルの種類</h4>
                                        <ul className="list-disc pl-5 text-xs space-y-1">
                                            <li><span className="font-bold text-red-600">未提出</span>: CSVデータが存在しない社員です。</li>
                                            <li><span className="font-bold text-gray-600">社員未登録</span>: CSVデータはあるが、定期設定に名前がない社員です。</li>
                                            <li><span className="font-bold text-yellow-600">定期重複あり</span>: 定期区間内での課金利用が含まれる社員です。</li>
                                            <li><span className="font-bold text-orange-600">要確認（その他）</span>: 休日利用、対象外（バス等）、駅名不明など、重複以外の確認事項がある社員です。</li>
                                            <li><span className="font-bold text-blue-600">確認OK</span>: 「要確認」からチェック済みに移動した社員です。</li>
                                            <li><span className="font-bold text-green-600">利用なし連絡済</span>: 「未提出」から連絡済みに移動した社員です。</li>
                                        </ul>
                                    </div>
                                    
                                    <div>
                                        <h4 className="font-bold border-b border-gray-200 mb-1">操作方法（リストの移動）</h4>
                                        <ul className="list-disc pl-5 text-xs space-y-1">
                                            <li><strong>詳細へ移動:</strong> 各リストの名前を<span className="font-bold">シングルクリック</span>すると、その社員の詳細カードへスクロールします。</li>
                                            <li><strong>確認完了/解除:</strong> 「要確認（その他）」の名前を<span className="font-bold">ダブルクリック</span>すると、「確認OK」へ移動します（逆も同様）。</li>
                                            <li><strong>利用なし登録:</strong> 「未提出」の名前をクリックすると、「利用なし連絡済」へ移動します。</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <h4 className="font-bold border-b border-gray-200 mb-1">アラート・リンク機能</h4>
                                        <ul className="list-disc pl-5 text-xs space-y-1">
                                            <li>定期重複がある場合、備考欄に重複区間（例：大阪⇔新大阪）が表示されます。</li>
                                            <li>表示された区間をクリックすると、<span className="text-blue-600 underline">Yahoo!路線情報</span>でその区間の検索結果（運賃等）を別タブで開きます。</li>
                                            <li>CSV出力時は、入場記録がないデータ（退場のみ）の時間表記に「'」を付与し、Excelでのエラーを防いでいます。</li>
                                        </ul>
                                    </div>
                                </div>
                            </section>

                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">4. 設定の保存</h3>
                                <p>登録した社員データや独自の設定（休日・ゆらぎ）は、「設定データ操作」からCSVファイルとして保存（エクスポート）できるほか、<strong>保存と同時にブラウザ（現在ご使用の環境）にも記憶されます。</strong>次回アクセス時は自動で読み込まれます。</p>
                            </section>
                            
                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">5. 対象事業者・駅一覧</h3>
                                <p className="mb-2">本ツールでチェック可能な事業者と路線は以下の通りです。</p>
                                <div className="h-64 overflow-y-auto border p-2 bg-gray-50 rounded text-xs font-mono whitespace-pre-wrap">
                                    {Object.entries(STATION_DATA).map(([company, lines]) => (
                                        <div key={company} className="mb-2">
                                            <div className="font-bold">【{company}】</div>
                                            {Object.entries(lines).map(([line, stations]) => (
                                                <div key={line} className="ml-2">
                                                    <span className="font-semibold">・{line}:</span> {stations.join(", ")}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>
                            </section>

                            <section>
                                <h3 className="font-bold text-base text-blue-800 mb-2">6. 経路探索と判定ロジックについて</h3>
                                <div className="pl-4 space-y-2 text-xs">
                                    <p>本ツールは、簡易的な経路探索アルゴリズムを用いて定期区間との重複を判定しています。</p>
                                    <ul className="list-disc pl-5">
                                        <li><strong>接続点:</strong> 同一事業者の同名駅、および以下の相互直通運転等で指定された接続点を経由して経路を探索します。</li>
                                        <li className="mt-2 mb-2">
                                            <strong>設定されている相互直通・乗換接続駅:</strong>
                                            <div className="h-32 overflow-y-auto border p-2 bg-gray-50 rounded mt-1 font-mono">
                                                {INTER_COMPANY_CONNECTIONS.map((conn, i) => (
                                                    <div key={i}>・{conn.station} ({conn.companies.join(" ⇔ ")})</div>
                                                ))}
                                            </div>
                                        </li>
                                        <li><strong>大阪環状線の扱い:</strong> 大阪環状線は「天満」と「大阪」が接続され、環状線として探索されます。</li>
                                        <li><strong>事業者またぎ:</strong> 定期区間が異なる事業者にまたがる場合（例：Osaka Metro～阪急）も判定可能です。</li>
                                        <li><strong>重複判定:</strong> 探索された経路上の駅の並びと、登録された定期区間の駅の並びを比較し、2駅以上連続して一致する区間がある場合、その部分を「定期重複」とみなします。</li>
                                    </ul>
                                </div>
                            </section>
                        </div>
                        <div className="mt-6 text-center">
                            <button onClick={onClose} className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">閉じる</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 modal-overlay no-print">
                    <div className="bg-white p-6 rounded-lg max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Icons.History /> 更新履歴</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 font-bold text-2xl">×</button>
                        </div>
                        <div className="space-y-4 text-sm text-gray-700">
                            <div className="border-l-4 border-blue-500 pl-3">
                                <h3 className="font-bold text-blue-700">v55 (Current)</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>設定のブラウザ保存機能を追加（「保存(CSV)」実行時にブラウザにも自動保存）</li>
                                    <li>設定の初期化ボタンを追加</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v54</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>CSVの日付形式が混在（2026/01/14と2026/1/14）している場合に月次集計が分かれてしまう問題を修正</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v53</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>ユーザーマニュアルの「対象事業者・駅一覧」と「接続駅リスト」を復活</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v52</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>ユーザーマニュアルの更新（入力例、操作説明の拡充）</li>
                                    <li>更新履歴画面の追加</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v51</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>定期区間登録UIの改修（発着駅それぞれで事業者選択が可能に）</li>
                                    <li>発側の入力時に着側を自動同期する機能の追加</li>
                                    <li>事業者またぎの定期区間に対応した経路探索ロジックの修正</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v50</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>重複区間表示の改善（連続する区間を結合して表示）</li>
                                    <li>Yahoo!路線情報リンクの検索条件を適正化（起終点での検索に変更）</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v49</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>定期区間未登録者のリストアップ機能追加</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v48</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>CSV出力時、入場記録がない時間のExcel表示エラー対策を追加</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v47</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>バス利用などの「対象外」項目も要確認件数に含めるよう変更</li>
                                    <li>CSV出力の微調整</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v46</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>リスト操作の改善（ダブルクリック判定用のタイマー導入）</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v45</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>「要確認」リストの名前クリックで詳細へ移動、ダブルクリックで「確認OK」へ移動する機能の実装</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v44</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>「要確認（その他）」リストの追加</li>
                                    <li>「確認OK」機能（トグル）の実装</li>
                                </ul>
                            </div>
                            <div className="border-l-4 border-gray-300 pl-3">
                                <h3 className="font-bold text-gray-700">v43</h3>
                                <ul className="list-disc pl-5 text-gray-600">
                                    <li>結果CSV出力機能の実装</li>
                                    <li>バージョン表記の統一</li>
                                </ul>
                            </div>
                        </div>
                        <div className="mt-6 text-center">
                            <button onClick={onClose} className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">閉じる</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DoubleClickButton = ({ children, onClick, onDoubleClick, className, title }) => {
            const timerRef = useRef(null);

            const handleClick = (e) => {
                if (timerRef.current) {
                    clearTimeout(timerRef.current);
                    timerRef.current = null;
                    return;
                }
                
                timerRef.current = setTimeout(() => {
                    onClick();
                    timerRef.current = null;
                }, 300);
            };

            const handleDoubleClick = (e) => {
                if (timerRef.current) {
                    clearTimeout(timerRef.current);
                    timerRef.current = null;
                }
                onDoubleClick();
            };

            useEffect(() => {
                return () => {
                    if (timerRef.current) clearTimeout(timerRef.current);
                };
            }, []);

            return (
                <button
                    onClick={handleClick}
                    onDoubleClick={handleDoubleClick}
                    className={className}
                    title={title}
                >
                    {children}
                </button>
            );
        };

        // --- 定数・マスタデータ ---

        const STATION_DATA = {
            "JR西日本": {
                "京都線・神戸線・琵琶湖線": ["米原", "彦根", "南彦根", "河瀬", "稲枝", "能登川", "安土", "近江八幡", "篠原", "野洲", "守山", "栗東", "草津", "南草津", "瀬田", "石山", "膳所", "大津", "山科", "京都", "西大路", "桂川", "向日町", "長岡京", "山崎", "島本", "高槻", "摂津富田", "ＪＲ総持寺", "茨木", "千里丘", "岸辺", "吹田", "東淀川", "新大阪", "大阪", "塚本", "尼崎", "立花", "甲子園口", "西宮", "さくら夙川", "芦屋", "甲南山手", "摂津本山", "住吉", "六甲道", "摩耶", "灘", "三ノ宮", "元町", "神戸", "兵庫", "新長田", "鷹取", "須磨海浜公園", "須磨", "塩屋", "垂水", "舞子", "朝霧", "明石", "西明石", "大久保", "魚住", "土山", "東加古川", "加古川", "宝殿", "曽根", "ひめじ別所", "御着", "東姫路", "姫路"],
                "山陽本線(姫路-相生)": ["姫路", "英賀保", "はりま勝原", "網干", "竜野", "相生"],
                "宝塚線(福知山線)": ["尼崎", "塚口", "猪名寺", "伊丹", "北伊丹", "川西池田", "中山寺", "宝塚", "生瀬", "西宮名塩", "武田尾", "道場", "三田", "新三田"],
                "東西線・学研都市線": ["木津", "西木津", "祝園", "下狛", "ＪＲ三山木", "同志社前", "京田辺", "大住", "松井山手", "長尾", "藤阪", "津田", "河内磐船", "星田", "寝屋川公園", "忍ヶ丘", "四条畷", "野崎", "住道", "鴻池新田", "徳庵", "放出", "鴫野", "京橋", "大阪城北詰", "大阪天満宮", "北新地", "新福島", "海老江", "御幣島", "加島", "尼崎"],
                "大阪環状線": ["大阪", "福島", "野田", "西九条", "弁天町", "大正", "芦原橋", "今宮", "新今宮", "天王寺", "寺田町", "桃谷", "鶴橋", "玉造", "森ノ宮", "大阪城公園", "京橋", "桜ノ宮", "天満", "大阪"],
                "阪和線": ["天王寺", "美章園", "南田辺", "鶴ヶ丘", "長居", "我孫子町", "杉本町", "浅香", "堺市", "三国ヶ丘", "百舌鳥", "上野芝", "津久野", "鳳", "富木", "北信太", "信太山", "和泉府中", "久米田", "下松", "東岸和田", "東貝塚", "和泉橋本", "東佐野", "熊取", "日根野", "りんくうタウン", "関西空港"],
                "大和路線": ["加茂", "木津", "平城山", "奈良", "郡山", "大和小泉", "法隆寺", "王寺", "三郷", "河内堅上", "高井田", "柏原", "志紀", "八尾", "久宝寺", "加美", "平野", "東部市場前", "天王寺", "新今宮", "今宮", "ＪＲ難波"],
                "赤穂線": ["相生", "西相生", "坂越", "播州赤穂", "天和", "備前福河", "日生", "寒河", "邑久", "長船", "香登", "伊部", "西片上", "西大寺", "大富", "東岡山"],
                "湖西線": ["京都", "山科", "大津京", "唐崎", "比叡山坂本", "おごと温泉", "堅田", "小野", "和邇", "蓬莱", "志賀", "比良", "近江舞子", "北小松", "近江高島", "安曇川", "新旭", "近江今津", "近江中庄", "マ口", "永原"],
                "草津線": ["草津", "手原", "石部", "甲西", "三雲", "貴生川", "甲南", "寺庄", "甲賀", "油日", "柘植"],
                "奈良線": ["京都", "東福寺", "稲荷", "ＪＲ藤森", "桃山", "六地蔵", "木幡", "黄檗", "宇治", "ＪＲ小倉", "新田", "城陽", "長池", "山城青谷", "山城多賀", "玉水", "棚倉", "上狛", "木津", "奈良"],
                "嵯峨野線(山陰本線)": ["京都", "梅小路京都西", "丹波口", "二条", "円町", "花園", "太秦", "嵯峨嵐山", "保津峡", "馬堀", "亀岡", "並河", "千代川", "八木", "吉富", "園部"],
                "おおさか東線": ["大阪", "新大阪", "南吹田", "ＪＲ淡路", "城北公園通", "ＪＲ野江", "鴫野", "放出", "高井田中央", "ＪＲ河内永和", "ＪＲ俊徳道", "ＪＲ長瀬", "衣摺加美北", "新加美", "久宝寺"],
                "関西空港線": ["日根野", "りんくうタウン", "関西空港"],
                "和歌山線": ["王寺", "畠田", "志都美", "香芝", "ＪＲ五位堂", "高田", "大和新庄", "御所", "玉手", "掖上", "吉野口", "北宇智", "五条", "大和二見", "隅田", "下兵庫", "橋本", "紀伊山田", "高野口", "中飯降", "妙寺", "大谷", "笠田", "西笠田", "名手", "粉河", "紀伊長田", "打田", "下井阪", "岩出", "船戸", "紀伊小倉", "布施屋", "千旦", "田井ノ瀬", "和歌山"],
                "万葉まほろば線(桜井線)": ["奈良", "京終", "帯解", "山城", "櫟本", "天理", "長柄", "柳本", "巻向", "三輪", "桜井", "香久山", "畝傍", "金橋", "高田"]
            },
            "大阪メトロ": {
                "御堂筋線": ["江坂", "東三国", "新大阪", "西中島南方", "中津", "梅田", "淀屋橋", "本町", "心斎橋", "なんば", "大国町", "動物園前", "天王寺", "昭和町", "西田辺", "長居", "あびこ", "北花田", "新金岡", "なかもず"],
                "谷町線": ["大日", "守口", "太子橋今市", "千林大宮", "関目高殿", "野江内代", "都島", "天神橋筋六丁目", "中崎町", "東梅田", "南森町", "天満橋", "谷町四丁目", "谷町六丁目", "谷町九丁目", "四天王寺前夕陽ヶ丘", "天王寺", "阿倍野", "文の里", "田辺", "駒川中野", "平野", "喜連瓜破", "出戸", "長原", "八尾南"],
                "四つ橋線": ["西梅田", "肥後橋", "本町", "四ツ橋", "なんば", "大国町", "花園町", "岸里", "玉出", "北加賀屋", "住之江公園"],
                "中央線": ["コスモスクエア", "大阪港", "朝潮橋", "弁天町", "九条", "阿波座", "本町", "堺筋本町", "谷町四丁目", "森ノ宮", "緑橋", "深江橋", "高井田", "長田"],
                "夢洲線": ["コスモスクエア", "夢洲"],
                "千日前線": ["野田阪神", "玉川", "阿波座", "西長堀", "桜川", "なんば", "日本橋", "谷町九丁目", "鶴橋", "今里", "新深江", "小路", "北巽", "南巽"],
                "堺筋線": ["天神橋筋六丁目", "扇町", "南森町", "北浜", "堺筋本町", "長堀橋", "日本橋", "恵美須町", "動物園前", "天下茶屋"],
                "長堀鶴見緑地線": ["大正", "ドーム前千代崎", "西長堀", "西大橋", "心斎橋", "長堀橋", "松屋町", "谷町六丁目", "玉造", "森ノ宮", "大阪ビジネスパーク", "京橋", "蒲生四丁目", "今福鶴見", "横堤", "鶴見緑地", "門真南"],
                "今里筋線": ["井高野", "瑞光四丁目", "だいどう豊里", "太子橋今市", "清水", "新森古市", "関目成育", "蒲生四丁目", "鴫野", "緑橋", "今里"],
                "南港ポートタウン線(ニュートラム)": ["コスモスクエア", "トレードセンター前", "中ふ頭", "ポートタウン西", "ポートタウン東", "フェリーターミナル", "南港東", "南港口", "平林", "住之江公園"]
            },
            "北大阪急行": {
                "南北線": ["箕面萱野", "箕面船場阪大前", "千里中央", "桃山台", "緑地公園", "江坂"]
            },
            "大阪モノレール": {
                "本線": ["大阪空港", "蛍池", "柴原阪大前", "少路", "千里中央", "山田", "万博記念公園", "宇野辺", "南茨木", "沢良宜", "摂津", "南摂津", "大日", "門真市"],
                "彩都線": ["万博記念公園", "公園東口", "阪大病院前", "豊川", "彩都西"]
            },
            "山陽電車": {
                "本線": ["西代", "板宿", "東須磨", "月見山", "須磨寺", "山陽須磨", "須磨浦公園", "山陽塩屋", "滝の茶屋", "東垂水", "山陽垂水", "霞ヶ丘", "舞子公園", "西舞子", "大蔵谷", "人丸前", "山陽明石", "西新町", "林崎松江海岸", "藤江", "中八木", "江井ヶ島", "西江井ヶ島", "山陽魚住", "東二見", "西二見", "播磨町", "別府", "浜の宮", "尾上の松", "高砂", "荒井", "伊保", "山陽曽根", "大塩", "的形", "八家", "白浜の宮", "妻鹿", "飾磨", "亀山", "手柄", "山陽姫路"],
                "網干線": ["飾磨", "西飾磨", "夢前川", "広畑", "山陽天満", "平松", "山陽網干"]
            },
            "阪急電鉄": {
                "京都線": ["京都河原町", "烏丸", "大宮", "西院", "西京極", "桂", "洛西口", "東向日", "西向日", "長岡天神", "西山天王山", "大山崎", "水無瀬", "上牧", "高槻市", "富田", "総持寺", "茨木市", "南茨木", "摂津市", "正雀", "相川", "上新庄", "淡路", "崇禅寺", "南方", "十三", "大阪梅田"],
                "宝塚線": ["宝塚", "清荒神", "売布神社", "中山観音", "山本", "雲雀丘花屋敷", "川西能勢口", "池田", "石橋阪大前", "蛍池", "豊中", "岡町", "曽根", "服部天神", "庄内", "三国", "十三", "中津", "大阪梅田"],
                "神戸線": ["神戸三宮", "春日野道", "王子公園", "六甲", "御影", "岡本", "芦屋川", "夙川", "西宮北口", "武庫之荘", "塚口", "園田", "神崎川", "十三", "中津", "大阪梅田"],
                "千里線": ["北千里", "山田", "南千里", "千里山", "関大前", "豊津", "吹田", "下新庄", "淡路", "柴島", "天神橋筋六丁目"],
                "嵐山線": ["桂", "上桂", "松尾大社", "嵐山"],
                "今津線": ["宝塚", "宝塚南口", "逆瀬川", "小林", "仁川", "甲東園", "門戸厄神", "西宮北口", "阪神国道", "今津"],
                "箕面線": ["石橋阪大前", "桜井", "牧落", "箕面"],
                "伊丹線": ["塚口", "稲野", "新伊丹", "伊丹"],
                "甲陽線": ["夙川", "苦楽園口", "甲陽園"],
                "神戸高速線": ["神戸三宮", "花隈", "高速神戸", "新開地"]
            },
            "阪神電車": {
                "本線": ["元町", "神戸三宮", "春日野道", "岩屋", "西灘", "大石", "新在家", "石屋川", "御影", "住吉", "魚崎", "青木", "深江", "芦屋", "打出", "香櫨園", "西宮", "今津", "久寿川", "甲子園", "鳴尾・武庫川女子大前", "武庫川", "尼崎センタープール前", "出屋敷", "尼崎", "大物", "杭瀬", "千船", "姫島", "淀川", "野田", "福島", "大阪梅田"],
                "なんば線": ["大阪難波", "桜川", "ドーム前", "九条", "西九条", "千鳥橋", "伝法", "福", "出来島", "大物", "尼崎"],
                "神戸高速線": ["元町", "西元町", "高速神戸", "新開地", "大開", "高速長田", "西代"]
            },
            "京阪電車": {
                "本線": ["淀屋橋", "北浜", "天満橋", "京橋", "野江", "関目", "森小路", "千林", "滝井", "土居", "守口市", "西三荘", "門真市", "古川橋", "大和田", "萱島", "寝屋川市", "香里園", "光善寺", "枚方公園", "枚方市", "御殿山", "牧野", "樟葉", "橋本", "石清水八幡宮", "淀", "中書島", "伏見桃山", "丹波橋", "墨染", "藤森", "龍谷大前深草", "伏見稲荷", "鳥羽街道", "東福寺", "七条", "清水五条", "祇園四条", "三条", "神宮丸太町", "出町柳"],
                "鴨東線": ["三条", "神宮丸太町", "出町柳"],
                "中之島線": ["中之島", "渡辺橋", "大江橋", "なにわ橋", "天満橋"],
                "交野線": ["枚方市", "宮之阪", "星ヶ丘", "村野", "郡津", "交野市", "河内森", "私市"],
                "宇治線": ["中書島", "観月橋", "桃山南口", "六地蔵", "木幡", "黄檗", "三室戸", "宇治"],
                "京津線": ["御陵", "京阪山科", "四宮", "追分", "大谷", "上栄町", "びわ湖浜大津"],
                "石山坂本線": ["石山寺", "唐橋前", "京阪石山", "粟津", "瓦ヶ浜", "中ノ庄", "膳所本町", "錦", "京阪膳所", "石場", "島ノ関", "びわ湖浜大津", "三井寺", "大津市役所前", "京阪大津京", "近江神宮前", "南滋賀", "滋賀里", "穴太", "松ノ馬場", "坂本比叡山口"]
            },
            "近鉄電車": {
                "奈良線": ["大阪難波", "近鉄日本橋", "大阪上本町", "鶴橋", "今里", "布施", "河内永和", "河内小阪", "八戸ノ里", "若江岩田", "河内花園", "東花園", "瓢箪山", "枚岡", "額田", "石切", "生駒", "東生駒", "富雄", "学園前", "菖蒲池", "大和西大寺", "新大宮", "近鉄奈良"],
                "大阪線": ["大阪上本町", "鶴橋", "今里", "布施", "俊徳道", "長瀬", "弥刀", "久宝寺口", "近鉄八尾", "河内山本", "高安", "恩智", "法善寺", "堅下", "安堂", "河内国分", "大阪教育大前", "関屋", "二上", "近鉄下田", "五位堂", "築山", "大和高田", "松塚", "真菅", "大和八木", "耳成", "大福", "桜井", "大和朝倉", "長谷寺", "榛原", "室生口大野", "三本松", "赤目口", "名張", "伊賀神戸", "青山町", "伊賀上津", "西青山", "東青山", "榊原温泉口", "大三", "伊勢石橋", "川合高岡", "伊勢中川"],
                "京都線": ["京都", "東寺", "十条", "上鳥羽口", "竹田", "伏見", "近鉄丹波橋", "桃山御陵前", "向島", "小倉", "伊勢田", "大久保", "久津川", "寺田", "富野荘", "新田辺", "興戸", "三山木", "近鉄宮津", "狛田", "新祝園", "木津川台", "山田川", "高の原", "平城", "大和西大寺"],
                "南大阪線": ["大阪阿部野橋", "河堀口", "北田辺", "今川", "針中野", "矢田", "河内天美", "布忍", "高見ノ里", "河内松原", "恵我ノ荘", "高鷲", "藤井寺", "土師ノ里", "道明寺", "古市", "駒ヶ谷", "上ノ太子", "二上山", "二上神社口", "当麻寺", "磐城", "尺土", "高田市", "浮孔", "坊城", "橿原神宮前"],
                "吉野線": ["橿原神宮前", "岡寺", "飛鳥", "壺阪山", "市尾", "葛", "吉野口", "薬水", "福神", "大阿太", "下市口", "越部", "六田", "大和上市", "吉野神宮", "吉野"],
                "橿原線": ["大和西大寺", "尼ヶ辻", "西ノ京", "九条", "近鉄郡山", "筒井", "平端", "ファミリー公園前", "結崎", "石見", "田原本", "笠縫", "新ノ口", "大和八木", "八木西口", "畝傍御陵前", "橿原神宮前"],
                "天理線": ["平端", "二階堂", "前栽", "天理"],
                "田原本線": ["新王寺", "大輪田", "佐味田川", "池部", "箸尾", "但馬", "黒田", "西田原本"],
                "生駒線": ["王寺", "信貴山下", "勢野北口", "竜田川", "白庭台", "学研北生駒", "富雄", "東山", "元山上口", "平群", "菜畑", "一分", "南生駒", "萩の台", "生駒"],
                "けいはんな線": ["長田", "荒本", "吉田", "新石切", "生駒", "白庭台", "学研北生駒", "学研奈良登美ヶ丘"],
                "信貴線": ["河内山本", "服部川", "信貴山口"],
                "道明寺線": ["道明寺", "柏原南口", "柏原"],
                "長野線": ["古市", "喜志", "富田林", "富田林西口", "川西", "滝谷不動", "汐ノ宮", "河内長野"],
                "御所線": ["尺土", "近鉄新庄", "忍海", "近鉄御所"]
            },
            "南海電鉄": {
                "本線": ["難波", "新今宮", "天下茶屋", "岸里玉出", "粉浜", "住吉大社", "住ノ江", "七道", "堺", "湊", "石津川", "諏訪ノ森", "浜寺公園", "羽衣", "高石", "北助松", "松ノ浜", "泉大津", "忠岡", "春木", "和泉大宮", "岸和田", "蛸地蔵", "貝塚", "二色浜", "鶴原", "井原里", "泉佐野", "羽倉崎", "吉見ノ里", "岡田浦", "樽井", "尾崎", "鳥取ノ荘", "箱作", "淡輪", "みさき公園", "孝子", "和歌山大学前", "紀ノ川", "和歌山市"],
                "高野線": ["難波", "新今宮", "天下茶屋", "岸里玉出", "帝塚山", "住吉東", "沢ノ町", "我孫子前", "浅香山", "堺東", "三国ヶ丘", "百舌鳥八幡", "中百舌鳥", "白鷺", "初芝", "萩原天神", "北野田", "狭山", "大阪狭山市", "金剛", "滝谷", "千代田", "河内長野", "三日市町", "美加の台", "千早口", "天見", "紀見峠", "林間田園都市", "御幸辻", "橋本", "紀伊清水", "学文路", "九度山", "高野下", "下古沢", "上古沢", "紀伊細川", "紀伊神谷", "極楽橋", "高野山"],
                "空港線": ["泉佐野", "りんくうタウン", "関西空港"],
                "多奈川線": ["みさき公園", "深日町", "深日港", "多奈川"],
                "加太線": ["紀ノ川", "東松江", "中松江", "八幡前", "西ノ庄", "二里ヶ浜", "磯ノ浦", "加太"],
                "和歌山港線": ["和歌山市", "和歌山港"],
                "高師浜線": ["羽衣", "伽羅橋", "高師浜"],
                "汐見橋線": ["岸里玉出", "西天下茶屋", "津守", "木津川", "芦原町", "汐見橋"]
            },
            "京都市営地下鉄": {
                "烏丸線": ["国際会館", "松ヶ崎", "北山", "北大路", "鞍馬口", "今出川", "丸太町", "烏丸御池", "四条", "五条", "京都", "九条", "十条", "くいな橋", "竹田"],
                "東西線": ["六地蔵", "石田", "醍醐", "小野", "椥辻", "東野", "山科", "御陵", "蹴上", "東山", "三条京阪", "京都市役所前", "烏丸御池", "二条城前", "二条", "西大路御池", "太秦天神川"]
            },
            "神戸市営地下鉄": {
                "西神・山手線": ["谷上", "新神戸", "三宮", "県庁前", "大倉山", "湊川公園", "上沢", "長田", "新長田", "板宿", "妙法寺", "名谷", "総合運動公園", "学園都市", "伊川谷", "西神南", "西神中央"],
                "海岸線": ["三宮・花時計前", "旧居留地・大丸前", "みなと元町", "ハーバーランド", "中央市場前", "和田岬", "御崎公園", "苅藻", "駒ヶ林", "新長田"]
            },
            "京福電気鉄道": {
                "嵐山本線": ["四条大宮", "西院", "西大路三条", "山ノ内", "嵐電天神川", "蚕ノ社", "太秦広隆寺", "帷子ノ辻", "有栖川", "車折神社", "鹿王院", "嵐電嵯峨", "嵐山"],
                "北野線": ["北野白梅町", "等持院・立命館大学衣笠キャンパス前", "龍安寺", "妙心寺", "御室仁和寺", "宇多野", "鳴滝", "常盤", "撮影所前", "帷子ノ辻"]
            },
            "叡山電鉄": {
                "叡山本線": ["出町柳", "元田中", "茶山・京都芸術大学", "一乗寺", "修学院", "宝ヶ池", "三宅八幡", "八瀬比叡山口"],
                "鞍馬線": ["宝ヶ池", "八幡前", "岩倉", "木野", "京都精華大前", "二軒茶屋", "市原", "二ノ瀬", "貴船口", "鞍馬"]
            },
            "神戸電鉄": {
                "有馬線": ["湊川", "長田", "丸山", "鵯越", "鈴蘭台", "北鈴蘭台", "山の街", "箕谷", "谷上", "花山", "大池", "神鉄六甲", "唐櫃台", "有馬口", "有馬温泉"],
                "三田線": ["有馬口", "五社", "岡場", "田尾寺", "二郎", "道場南口", "神鉄道場", "横山", "三田本町", "三田"],
                "公園都市線": ["横山", "フラワータウン", "南ウッディタウン", "ウッディタウン中央"],
                "粟生線": ["鈴蘭台", "鈴蘭台西口", "西鈴蘭台", "藍那", "木津", "木幡", "栄", "押部谷", "緑が丘", "広野ゴルフ場前", "志染", "恵比須", "三木上の丸", "三木", "大村", "樫山", "市場", "小野", "葉多", "粟生"],
                "神戸高速線": ["新開地", "湊川"]
            },
            "能勢電鉄": {
                "妙見線": ["川西能勢口", "絹延橋", "滝山", "鶯の森", "鼓滝", "多田", "平野", "一の鳥居", "畦野", "山下", "笹部", "光風台", "ときわ台", "妙見口"],
                "日生線": ["山下", "日生中央"]
            },
            "泉北高速鉄道": {
                "泉北高速鉄道線": ["中百舌鳥", "深井", "泉ケ丘", "栂・美木多", "光明池", "和泉中央"]
            },
            "水間鉄道": {
                "水間線": ["貝塚", "貝塚市役所前", "近義の里", "石才", "清児", "名越", "森", "三ツ松", "三ヶ山口", "水間観音"]
            },
            "神戸新交通": {
                "ポートアイランド線": ["三宮", "貿易センター", "ポートターミナル", "中公園", "みなとじま", "市民広場", "医療センター", "計算科学センター", "神戸空港", "南公園", "中埠頭", "北埠頭"],
                "六甲アイランド線": ["住吉", "魚崎", "南魚崎", "アイランド北口", "アイランドセンター", "マリンパーク"]
            }
        };

        const INITIAL_COMPANY_ALIASES = [
            { from: "大地下鉄", to: "大阪メトロ" },
            { from: "大地", to: "大阪メトロ" },
            { from: "大シティ", to: "大阪メトロ" },
            { from: "神鉄", to: "神戸電鉄" },
            { from: "山陽", to: "山陽電車" },
            { from: "北急", to: "北大阪急行" },
            { from: "Ｊ西", to: "JR西日本" },
            { from: "ＪＲ", to: "JR西日本" },
            { from: "モノレール", to: "大阪モノレール" },
            { from: "近鉄", to: "近鉄電車" },
            { from: "京阪", to: "京阪電車" },
            { from: "阪神", to: "阪神電車" },
            { from: "阪急", to: "阪急電鉄" },
            { from: "南海", to: "南海電鉄" },
            { from: "神戸", to: "神戸市営地下鉄" },
            { from: "京都市", to: "京都市営地下鉄" },
            { from: "京福", to: "京福電気鉄道" },
            { from: "嵐電", to: "京福電気鉄道" },
            { from: "叡電", to: "叡山電鉄" },
            { from: "能勢", to: "能勢電鉄" },
            { from: "泉北", to: "泉北高速鉄道" },
            { from: "水間", to: "水間鉄道" },
            { from: "ポート", to: "神戸新交通" },
            { from: "六甲", to: "神戸新交通" },
        ];

        // 手動で設定する特殊な略称（自動生成ルールでカバーできないもの）
        const MANUAL_STATION_ALIASES = [
            // 特殊
            { from: "天茶", to: "天下茶屋", company: "南海" },
            { from: "新今", to: "新今宮", company: "南海" },
            { from: "関空", to: "関西空港", company: "南海" },
            { from: "上新", to: "上新庄", company: "阪急" },
            { from: "西宮", to: "西宮北口", company: "阪急" }, 
            { from: "西北", to: "西宮北口", company: "阪急" },
            { from: "尼セン", to: "尼崎センタープール前", company: "阪神" },
            { from: "千中", to: "千里中央", company: "北急" },
            { from: "万博", to: "万博記念公園", company: "モノレール" },
            { from: "市役所", to: "貝塚市役所前", company: "水間" },
            { from: "計算科学", to: "計算科学センター", company: "ポート" },
            { from: "医療", to: "医療センター", company: "ポート" },
            { from: "大宮", to: "四条大宮", company: "京福" },
            { from: "天神川", to: "嵐電天神川", company: "京福" },
            { from: "広隆寺", to: "太秦広隆寺", company: "京福" },
            { from: "嵯峨", to: "嵐電嵯峨", company: "京福" },
            { from: "白梅町", to: "北野白梅町", company: "京福" },
            { from: "等持院", to: "等持院・立命館大学衣笠キャンパス前", company: "京福" },
            { from: "茶山", to: "茶山・京都芸術大学", company: "叡電" },
            { from: "八瀬", to: "八瀬比叡山口", company: "叡電" },
            { from: "精華大", to: "京都精華大前", company: "叡電" },
            { from: "道場", to: "神鉄道場", company: "神鉄" },
            { from: "六甲", to: "神鉄六甲", company: "神鉄" },
            { from: "川西", to: "川西能勢口", company: "能勢" },
            { from: "日生", to: "日生中央", company: "能勢" },
            { from: "妙見", to: "妙見口", company: "能勢" },
            { from: "泉ヶ丘", to: "泉ケ丘", company: "泉北" },
            { from: "栂", to: "栂・美木多", company: "泉北" },
            { from: "橿原", to: "橿原神宮前", company: "近鉄" },
            { from: "阿部野", to: "大阪阿部野橋", company: "近鉄" },
            { from: "阿部野橋", to: "大阪阿部野橋", company: "近鉄" },
            { from: "樟葉", to: "樟葉", company: "京阪" },
            // 主要重複駅の明示
            { from: "梅田", to: "大阪梅田", company: "阪急" },
            { from: "梅田", to: "大阪梅田", company: "阪神" },
            { from: "梅田", to: "東梅田", company: "大阪メトロ" }, 
            { from: "梅田", to: "西梅田", company: "大阪メトロ" },
            { from: "難波", to: "大阪難波", company: "近鉄" },
            { from: "難波", to: "大阪難波", company: "阪神" },
            { from: "三宮", to: "神戸三宮", company: "阪急" },
            { from: "三宮", to: "神戸三宮", company: "阪神" },
            { from: "三宮", to: "三ノ宮", company: "JR" },
            { from: "大阪", to: "大阪梅田", company: "阪急" },
            { from: "大阪", to: "大阪梅田", company: "阪神" }
        ];

        const INITIAL_HOLIDAYS = [
            "2024-01-01", "2024-01-08", "2024-02-11", "2024-02-12", "2024-02-23", "2024-03-20", "2024-04-29", "2024-05-03", "2024-05-04", "2024-05-05", "2024-05-06", "2024-07-15", "2024-08-11", "2024-08-12", "2024-09-16", "2024-09-22", "2024-09-23", "2024-10-14", "2024-11-03", "2024-11-04", "2024-11-23",
            "2025-01-01", "2025-01-13", "2025-02-11", "2025-02-23", "2025-02-24", "2025-03-20", "2025-04-29", "2025-05-03", "2025-05-04", "2025-05-05", "2025-05-06", "2025-07-21", "2025-08-11", "2025-09-15", "2025-09-23", "2025-10-13", "2025-11-03", "2025-11-23", "2025-11-24",
            "2026-01-01", "2026-01-12", "2026-02-11", "2026-02-23", "2026-03-20", "2026-04-29", "2026-05-03", "2026-05-04", "2026-05-05", "2026-05-06", "2026-07-20", "2026-08-11", "2026-09-21", "2026-09-22", "2026-09-23", "2026-10-12", "2026-11-03", "2026-11-23"
        ];

        // --- 相互直通運転等の例外接続設定 ---
        const INTER_COMPANY_CONNECTIONS = [
            { station: "天神橋筋六丁目", companies: ["大阪メトロ", "阪急電鉄"] },
            { station: "江坂", companies: ["大阪メトロ", "北大阪急行"] },
            { station: "長田", companies: ["大阪メトロ", "近鉄電車"] },
            { station: "竹田", companies: ["京都市営地下鉄", "近鉄電車"] },
            { station: "御陵", companies: ["京都市営地下鉄", "京阪電車"] },
            { station: "大阪難波", companies: ["阪神電車", "近鉄電車"] },            
            { station: "西代", companies: ["阪神電車", "山陽電車"] }, // ←変更
            { station: "高速神戸", companies: ["阪急電鉄", "阪神電車"] }, // ←新規追加
            { station: "新開地", companies: ["阪急電鉄", "阪神電車", "神戸電鉄"] }, // ←新規追加
            { station: "川西能勢口", companies: ["阪急電鉄", "能勢電鉄"] }
        ];

        // --- ゆらぎ自動生成 ---
        const generateDefaultAliases = () => {
            const autoAliases = [];
            const prefixes = ["大阪", "神戸", "近鉄", "京阪", "阪神", "阪急", "山陽", "能勢", "南海", "高速"];

            Object.entries(STATION_DATA).forEach(([company, lines]) => {
                Object.values(lines).forEach(stations => {
                    stations.forEach(station => {
                        autoAliases.push({ from: station, to: station, company: company });
                        prefixes.forEach(prefix => {
                            if (station.startsWith(prefix) && station.length > prefix.length) {
                                const shortName = station.substring(prefix.length);
                                autoAliases.push({ from: shortName, to: station, company: company });
                            }
                        });
                        if (station.endsWith("市") && station.length > 2) {
                            autoAliases.push({ from: station.slice(0, -1), to: station, company: company });
                        }
                        if (station.endsWith("駅") && station.length > 1) {
                            autoAliases.push({ from: station.slice(0, -1), to: station, company: company });
                        }
                        if (station.includes("(") || station.includes("（")) {
                            const cleanName = station.replace(/[\(（].+?[\)）]/, "");
                            if (cleanName !== station) {
                                autoAliases.push({ from: cleanName, to: station, company: company });
                            }
                        }
                    });
                });
            });
            return autoAliases;
        };

        // --- ユーティリティ ---

        const checkIsHoliday = (dateStr, holidayList) => {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return false;
            const day = date.getDay();
            const month = date.getMonth() + 1;
            const d = date.getDate();
            if (day === 0 || day === 6) return true;
            if ((month === 12 && d >= 29) || (month === 1 && d <= 3)) return true;
            const formattedDate = dateStr.replace(/\//g, '-');
            const isoDate = date.toISOString().split('T')[0]; 
            return holidayList.includes(formattedDate) || holidayList.includes(isoDate);
        };

        const getHolidayType = (dateStr, holidayList) => {
            const parts = dateStr.split(/[\/\-]/);
            if (parts.length !== 3) return null;
            
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; 
            const day = parseInt(parts[2], 10);
            
            const date = new Date(year, month, day);
            if (isNaN(date.getTime())) return null;
            
            const dayOfWeek = date.getDay(); 
            
            const pad = (n) => n < 10 ? '0' + n : n;
            const yyyymmdd_slash = `${year}/${pad(month+1)}/${pad(day)}`; 
            const yyyymmdd_hyphen = `${year}-${pad(month+1)}-${pad(day)}`;

            if (holidayList.includes(yyyymmdd_hyphen) || holidayList.includes(yyyymmdd_slash)) {
                return 'holiday';
            }
            
            if ((month === 11 && day >= 29) || (month === 0 && day <= 3)) {
                return 'holiday';
            }

            if (dayOfWeek === 0) return 'sunday';
            if (dayOfWeek === 6) return 'saturday';

            return null;
        };

        const parseCSV = (text, fileName) => {
            const lines = text.split(/\r\n|\n/);
            const results = [];
            let currentName = "不明";
            const nameRegex = /【(.+?)\s*様ご利用分】/;

            lines.forEach((line, index) => {
                const cleanLine = line.replace(/"/g, "");
                const nameMatch = cleanLine.match(nameRegex);
                if (nameMatch) {
                    currentName = nameMatch[1].trim();
                    return;
                }
                const columns = line.split(",").map(c => c.trim().replace(/"/g, ""));
                if (columns.length >= 5 && columns[0].match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                    const entryTime = columns[1];
                    const exitTime = columns[2];
                    let timeDisplay = "";
                    if (entryTime && exitTime) timeDisplay = `${entryTime} - ${exitTime}`;
                    else if (entryTime) timeDisplay = `${entryTime} -`;
                    else if (exitTime) timeDisplay = `- ${exitTime}`;

                    results.push({
                        id: `${fileName}-${index}`,
                        name: currentName,
                        date: columns[0],
                        time: timeDisplay,
                        content: columns[3],
                        amount: parseInt(columns[4]),
                        note: columns[5] || "",
                        fileName
                    });
                }
            });
            return results;
        };

        const resolveCompanyAlias = (prefix, companyAliases) => {
            const found = companyAliases.find(a => a.from === prefix || prefix.includes(a.from));
            return found ? found.to : prefix;
        };

        const resolveStationAlias = (stationName, aliases, targetCompanyPrefix, companyAliases) => {
            const normalizedCompany = resolveCompanyAlias(targetCompanyPrefix, companyAliases);
            const found = aliases.find(a => {
                const nameMatch = a.from === stationName;
                const companyMatch = !a.company || normalizedCompany.includes(a.company) || targetCompanyPrefix.includes(a.company);
                return nameMatch && companyMatch;
            });
            if (found) return found.to;

            if (STATION_DATA[normalizedCompany]) {
                const lines = Object.values(STATION_DATA[normalizedCompany]);
                for (const stations of lines) {
                    for (const masterStation of stations) {
                        if (masterStation.length >= 3 && stationName.length >= 3) {
                            if (masterStation.includes(stationName) || stationName.includes(masterStation)) {
                                return masterStation;
                            }
                        }
                    }
                }
            }
            return stationName;
        };

        const parseContent = (content, aliases, companyAliases) => {
            if (content.includes("嵐電（京福電車）")) {
                return {
                    from: "嵐電", 
                    to: "嵐電",   
                    companyPrefix: "京福",
                    isRandem: true
                };
            }

            if (!content.includes("－") && !content.includes("-")) return null;
            const parts = content.split(/[-－]/);
            if (parts.length !== 2) return null;

            const extractStation = (raw) => {
                const chunks = raw.trim().split(/[\s　]+/);
                if (chunks.length >= 2) {
                    return { prefix: chunks[0], station: chunks.slice(1).join("") };
                }
                return { prefix: "", station: raw.trim() };
            };

            const fromInfo = extractStation(parts[0]);
            const toInfo = extractStation(parts[1]);
            
            const fromStation = resolveStationAlias(fromInfo.station, aliases, fromInfo.prefix, companyAliases);
            const toStation = resolveStationAlias(toInfo.station, aliases, toInfo.prefix, companyAliases);

            return {
                from: fromStation,
                to: toStation,
                companyPrefix: fromInfo.prefix || toInfo.prefix 
            };
        };

        const checkStationExists = (stationName, companyPrefix, companyAliases) => {
            const companyName = resolveCompanyAlias(companyPrefix, companyAliases);
            const allCompanies = Object.keys(STATION_DATA);
            let exists = false;

            if (companyName && STATION_DATA[companyName]) {
                Object.values(STATION_DATA[companyName]).forEach(lineStations => {
                    if (lineStations.includes(stationName)) exists = true;
                });
            }

            if (!exists) {
                allCompanies.forEach(c => {
                    Object.values(STATION_DATA[c]).forEach(lineStations => {
                        if (lineStations.includes(stationName)) exists = true;
                    });
                });
            }
            return exists;
        };

        // --- グラフ・経路探索ロジック ---

        // ==========================================
// 【変更後】新しいコード（梅田3駅ルール追加）
// ==========================================
        const buildStationGraph = () => {
            const graph = {}; 
            
            const getNodeKey = (company, station) => `${company}:${station}`;
            const addEdge = (node1, node2) => {
                if (!graph[node1]) graph[node1] = new Set();
                if (!graph[node2]) graph[node2] = new Set();
                graph[node1].add(node2);
                graph[node2].add(node1);
            };

            // 1. 各路線のマスターデータから隣接する駅を繋ぐ
            Object.entries(STATION_DATA).forEach(([company, lines]) => {
                Object.values(lines).forEach(stations => {
                    for (let i = 0; i < stations.length - 1; i++) {
                        const node1 = getNodeKey(company, stations[i]);
                        const node2 = getNodeKey(company, stations[i+1]);
                        addEdge(node1, node2);
                    }
                });
            });

            // 2. 相互直通運転など、あらかじめ設定された他社線との接続駅を繋ぐ
            INTER_COMPANY_CONNECTIONS.forEach(conn => {
                const { station, companies } = conn;
                for (let i = 0; i < companies.length; i++) {
                    for (let j = i + 1; j < companies.length; j++) {
                        const node1 = getNodeKey(companies[i], station);
                        const node2 = getNodeKey(companies[j], station);
                        if (graph[node1] && graph[node2]) {
                            addEdge(node1, node2);
                        }
                    }
                }
            });

            // --- ここから追加：Osaka Metro 梅田3駅の改札外乗り継ぎルール対応 ---
            // 目的: 「南森町(谷町線)～なんば(御堂筋線)」のような、梅田での改札外徒歩乗り換えを含む定期券について、
            //       経路探索(findShortestPath)が途切れることなく正常にルートを導き出せるようにする。
            
            const umedaNode = getNodeKey("大阪メトロ", "梅田");
            const higashiUmedaNode = getNodeKey("大阪メトロ", "東梅田");
            const nishiUmedaNode = getNodeKey("大阪メトロ", "西梅田");

            // マスターデータが存在しているか（不意のデータ削除によるエラー回避）をチェックした上で、
            // 3つの駅を相互に結ぶエッジ（経路）を追加する。
            if (graph[umedaNode] && graph[higashiUmedaNode] && graph[nishiUmedaNode]) {
                addEdge(umedaNode, higashiUmedaNode);      // 梅田 ⇔ 東梅田 を繋ぐ
                addEdge(umedaNode, nishiUmedaNode);        // 梅田 ⇔ 西梅田 を繋ぐ
                addEdge(higashiUmedaNode, nishiUmedaNode); // 東梅田 ⇔ 西梅田 を繋ぐ
            }
            // --- ここまで追加 ---

            return graph;
        };
// ==========================================

        const findShortestPath = (startNodes, endNodes, graph) => {
            if (startNodes.length === 0 || endNodes.length === 0) return null;
            
            const queue = startNodes.map(node => [node]);
            const visited = new Set(startNodes);
            const targetSet = new Set(endNodes);

            while (queue.length > 0) {
                const path = queue.shift();
                const currentNode = path[path.length - 1];

                if (targetSet.has(currentNode)) {
                    return path;
                }

                const neighbors = graph[currentNode];
                if (neighbors) {
                    neighbors.forEach(neighbor => {
                        if (!visited.has(neighbor)) {
                            visited.add(neighbor);
                            queue.push([...path, neighbor]);
                        }
                    });
                }
            }
            return null;
        };

        // ヘルパー: パスに含まれる路線名を取得
        const getRoutesInPath = (pathNodes) => {
            const routes = new Set();
            for (let i = 0; i < pathNodes.length - 1; i++) {
                const [c1, s1] = pathNodes[i].split(':');
                const [c2, s2] = pathNodes[i+1].split(':');
                
                if (c1 === c2) {
                    // 同一会社
                    if (STATION_DATA[c1]) {
                        Object.entries(STATION_DATA[c1]).forEach(([line, stations]) => {
                             // 隣接チェック (インデックスの差が1)
                             const idx1 = stations.indexOf(s1);
                             const idx2 = stations.indexOf(s2);
                             // 通常の路線
                             if (idx1 !== -1 && idx2 !== -1 && Math.abs(idx1 - idx2) === 1) {
                                 routes.add(line);
                             }
                             // 環状線対応 (末尾と先頭)
                             if (idx1 !== -1 && idx2 !== -1) {
                                 const len = stations.length;
                                 if ((idx1 === 0 && idx2 === len - 1) || (idx1 === len - 1 && idx2 === 0)) {
                                      // 環状線対応
                                 }
                             }
                        });
                    }
                }
            }
            return Array.from(routes);
        };

const checkPathOverlap = (usagePath, passPath) => {
            if (!usagePath || !passPath) return null;

            // 定期券の経路(passPath)から、駅と駅の繋がり(エッジ)を双方向でSetに登録する
            const passEdges = new Set();
            for (let i = 0; i < passPath.length - 1; i++) {
                const edge1 = `${passPath[i]}-${passPath[i+1]}`;
                const edge2 = `${passPath[i+1]}-${passPath[i]}`; 
                passEdges.add(edge1);
                passEdges.add(edge2);
            }

            // ==========================================
            // JR西日本 大阪駅・北新地駅の特例ルール対応 (適用済み)
            // ==========================================
            const ST_AMAGASAKI = "JR西日本:尼崎";
            const ST_OSAKA = "JR西日本:大阪";
            const ST_KITASHINCHI = "JR西日本:北新地";
            const ST_KYOBASHI = "JR西日本:京橋";

            const isSubPath = (path, st1, st2) => {
                const idx1 = path.indexOf(st1);
                const idx2 = path.indexOf(st2);
                return idx1 !== -1 && idx2 !== -1 && idx1 !== idx2;
            };

            const addVirtualEdges = (sourcePath, st1, st2) => {
                const idx1 = sourcePath.indexOf(st1);
                const idx2 = sourcePath.indexOf(st2);
                const start = Math.min(idx1, idx2);
                const end = Math.max(idx1, idx2);
                for (let i = start; i < end; i++) {
                    passEdges.add(`${sourcePath[i]}-${sourcePath[i+1]}`);
                    passEdges.add(`${sourcePath[i+1]}-${sourcePath[i]}`);
                }
            };

            if (isSubPath(passPath, ST_AMAGASAKI, ST_OSAKA) && isSubPath(usagePath, ST_AMAGASAKI, ST_KITASHINCHI)) {
                addVirtualEdges(usagePath, ST_AMAGASAKI, ST_KITASHINCHI);
            } else if (isSubPath(passPath, ST_AMAGASAKI, ST_KITASHINCHI) && isSubPath(usagePath, ST_AMAGASAKI, ST_OSAKA)) {
                addVirtualEdges(usagePath, ST_AMAGASAKI, ST_OSAKA);
            }

            if (isSubPath(passPath, ST_KYOBASHI, ST_OSAKA) && isSubPath(usagePath, ST_KYOBASHI, ST_KITASHINCHI)) {
                addVirtualEdges(usagePath, ST_KYOBASHI, ST_KITASHINCHI);
            } else if (isSubPath(passPath, ST_KYOBASHI, ST_KITASHINCHI) && isSubPath(usagePath, ST_KYOBASHI, ST_OSAKA)) {
                addVirtualEdges(usagePath, ST_KYOBASHI, ST_OSAKA);
            }

            // ==========================================
            // 大阪メトロ 御堂筋線・四つ橋線 相互利用制度対応 (今回追加)
            // ==========================================
            // 特定の2駅間の区間(エッジ)が定期券に含まれている場合、
            // 対応する別路線の区間も「定期圏内」としてパスプール(passEdges)に追加・同期するヘルパー関数
            const syncEdges = (stA1, stA2, stB1, stB2) => {
                const edgeA1 = `${stA1}-${stA2}`;
                const edgeA2 = `${stA2}-${stA1}`;
                const edgeB1 = `${stB1}-${stB2}`;
                const edgeB2 = `${stB2}-${stB1}`;

                // 御堂筋線側の区間(A)を持っていれば、四つ橋線側の区間(B)を合法ルートとして追加
                if (passEdges.has(edgeA1) || passEdges.has(edgeA2)) {
                    passEdges.add(edgeB1);
                    passEdges.add(edgeB2);
                }
                // 四つ橋線側の区間(B)を持っていれば、御堂筋線側の区間(A)を合法ルートとして追加
                if (passEdges.has(edgeB1) || passEdges.has(edgeB2)) {
                    passEdges.add(edgeA1);
                    passEdges.add(edgeA2);
                }
            };

            // 駅名のプレフィックス定義
            const OM = "大阪メトロ:";

            // 4つの並行ブロックごとに区間を同期（双方向にコピー）
            // ※「本町」と「なんば」は両線で同一ノードとして扱われているため、そのまま同じ駅名を指定しています
            // 1. 梅田～淀屋橋 ⇔ 西梅田～肥後橋
            syncEdges(`${OM}梅田`, `${OM}淀屋橋`, `${OM}西梅田`, `${OM}肥後橋`);
            // 2. 淀屋橋～本町 ⇔ 肥後橋～本町
            syncEdges(`${OM}淀屋橋`, `${OM}本町`, `${OM}肥後橋`, `${OM}本町`);
            // 3. 本町～心斎橋 ⇔ 本町～四ツ橋
            syncEdges(`${OM}本町`, `${OM}心斎橋`, `${OM}本町`, `${OM}四ツ橋`);
            // 4. 心斎橋～なんば ⇔ 四ツ橋～なんば
            syncEdges(`${OM}心斎橋`, `${OM}なんば`, `${OM}四ツ橋`, `${OM}なんば`);
            // ==========================================

            let maxOverlapStart = -1;
            let currentOverlapLength = 0;
            let overlaps = [];

            // 利用経路(usagePath)のエッジが、定期券の有効エッジ(passEdges)に含まれているか順番に確認
            for (let i = 0; i < usagePath.length - 1; i++) {
                const edge = `${usagePath[i]}-${usagePath[i+1]}`;
                if (passEdges.has(edge)) {
                    if (currentOverlapLength === 0) maxOverlapStart = i;
                    currentOverlapLength++;
                } else {
                    if (currentOverlapLength > 0) {
                        overlaps.push({ start: maxOverlapStart, end: maxOverlapStart + currentOverlapLength });
                    }
                    currentOverlapLength = 0;
                }
            }
            if (currentOverlapLength > 0) {
                overlaps.push({ start: maxOverlapStart, end: maxOverlapStart + currentOverlapLength });
            }

            // 連続する重複区間を結合する処理
            const mergedOverlaps = [];
            if (overlaps.length > 0) {
                let current = overlaps[0];
                for (let i = 1; i < overlaps.length; i++) {
                    // 終了地点と開始地点が同じ（駅を共有）なら結合
                    if (overlaps[i].start === current.end) {
                        current.end = overlaps[i].end;
                    } else {
                        mergedOverlaps.push(current);
                        current = overlaps[i];
                    }
                }
                mergedOverlaps.push(current);
            }

            // 重複テキストの生成
            if (mergedOverlaps.length > 0) {
                const overlapTexts = mergedOverlaps.map(ov => {
                    const startNode = usagePath[ov.start];
                    const endNode = usagePath[ov.end];
                    
                    const [sComp, sName] = startNode.split(':');
                    const [eComp, eName] = endNode.split(':');
                    
                    if (sName === eName) return null;

                    const subPath = usagePath.slice(ov.start, ov.end + 1);
                    const lines = new Set();
                    for(let i=0; i<subPath.length-1; i++){
                        const [c1, st1] = subPath[i].split(':');
                        const [c2, st2] = subPath[i+1].split(':');
                        if(c1 === c2 && STATION_DATA[c1]){
                             Object.entries(STATION_DATA[c1]).forEach(([lName, stations]) => {
                                 if(stations.includes(st1) && stations.includes(st2) && Math.abs(stations.indexOf(st1)-stations.indexOf(st2))===1){
                                     lines.add(lName);
                                 }
                             });
                        }
                    }
                    
                    const lineStr = lines.size > 0 ? `(${Array.from(lines).join("・")}) ` : "";
                    return `${lineStr}${sName}⇔${eName}`;
                }).filter(text => text !== null);

                return [...new Set(overlapTexts)].join(", ");
            }
            return null;
        };

// ==========================================
// 【修正後】checkRouteOverlap 関数一式
// ==========================================
        const checkRouteOverlap = (usage, pass, companyAliases, graph) => {
            // 嵐電(均一区間)の特殊処理
            if (usage.isRandem) {
                if (pass.company === "京福電気鉄道") {
                    return { isOverlap: true, overlapText: "定期区間内(均一)", usagePathStr: "嵐電(利用)", passPathStr: "嵐電(定期)" };
                }
                return { isOverlap: false };
            }

            const pFromComp = pass.fromCompany || pass.company;
            const pFromSt   = pass.fromStation || pass.from;
            const pToComp   = pass.toCompany   || pass.company;
            const pToSt     = pass.toStation   || pass.to;

            const passStartNode = `${pFromComp}:${pFromSt}`;
            const passEndNode   = `${pToComp}:${pToSt}`;
            
            if (!graph[passStartNode] || !graph[passEndNode]) return { isOverlap: false };

            const passPath = findShortestPath([passStartNode], [passEndNode], graph);
            if (!passPath) return { isOverlap: false }; 

            const usageCompany = resolveCompanyAlias(usage.companyPrefix, companyAliases);
            
            const findCandidateNodes = (stationName, preferredCompany) => {
                const candidates = [];
                if (preferredCompany && preferredCompany !== "その他") {
                    const key = `${preferredCompany}:${stationName}`;
                    if (graph[key]) candidates.push(key);
                }
                if (candidates.length === 0) {
                    Object.keys(STATION_DATA).forEach(c => {
                        const key = `${c}:${stationName}`;
                        if (graph[key]) candidates.push(key);
                    });
                }
                return candidates;
            };

            const usageStartNodes = findCandidateNodes(usage.from, usageCompany);
            const usageEndNodes = findCandidateNodes(usage.to, usageCompany);

            if (usageStartNodes.length === 0 || usageEndNodes.length === 0) return { isOverlap: false };

            const usagePath = findShortestPath(usageStartNodes, usageEndNodes, graph);
            if (!usagePath) return { isOverlap: false };

            // --- 追加：事業者の共通チェック（関係ない路線の場合はここで弾く） ---
            const getCompaniesInPath = (pathNodes) => {
                const companies = new Set();
                pathNodes.forEach(node => companies.add(node.split(':')[0]));
                return companies;
            };
            const usageCompanies = getCompaniesInPath(usagePath);
            const passCompanies = getCompaniesInPath(passPath);
            
            // 利用経路と定期経路に、1つでも共通の事業者が含まれているか判定（相互乗り入れ考慮）
            const hasCommonCompany = [...usageCompanies].some(c => passCompanies.has(c));
            
            // 共通事業者が全くなければ、重複する可能性はないので経路情報も返さずに終了
            if (!hasCommonCompany) {
                return { isOverlap: false }; 
            }
            // ----------------------------------------------------------------

            const formatPath = (pathNodes) => {
                if (!pathNodes) return "";
                return pathNodes.map(node => node.split(':')[1]).join(' → ');
            };
            const usagePathStr = formatPath(usagePath);
            const passPathStr = formatPath(passPath);

            const overlapText = checkPathOverlap(usagePath, passPath);
            
            if (overlapText) {
                return { isOverlap: true, overlapText, usagePathStr, passPathStr };
            }

            return { isOverlap: false, usagePathStr, passPathStr };
        };
// ==========================================

        const App = () => {
            const [activeTab, setActiveTab] = useState('upload');
            const [files, setFiles] = useState([]);
            const [parsedData, setParsedData] = useState([]);
            
            // Settings
            const [users, setUsers] = useState([]);
            const [holidays, setHolidays] = useState(INITIAL_HOLIDAYS);
            const [holidayInput, setHolidayInput] = useState(INITIAL_HOLIDAYS.join('\n'));
            const [aliases, setAliases] = useState([...generateDefaultAliases(), ...MANUAL_STATION_ALIASES]);
            const [companyAliases, setCompanyAliases] = useState(INITIAL_COMPANY_ALIASES);
            const [noUsageUsers, setNoUsageUsers] = useState([]);
            
            const [checkedOkUsers, setCheckedOkUsers] = useState([]);
            // v51変更: 2カラム用State
            const [editingPass, setEditingPass] = useState({
                fromCompany: "JR西日本", fromLine: "", fromStation: "",
                toCompany: "JR西日本", toLine: "", toStation: ""
            });

            const [newAlias, setNewAlias] = useState({ from: "", to: "", company: "" });
            const [newCompanyAlias, setNewCompanyAlias] = useState({ from: "", to: "" });
            const [showHelp, setShowHelp] = useState(false);

            // グラフ構築 (キャッシュ)
            const stationGraph = useMemo(() => buildStationGraph(), []);

            // [v55] ローカルストレージからの読み込み
            useEffect(() => {
                const savedSettings = localStorage.getItem('pitapa_settings');
                if (savedSettings) {
                    try {
                        const data = JSON.parse(savedSettings);
                        if (data.users) setUsers(data.users);
                        if (data.holidays) {
                            setHolidays(data.holidays);
                            setHolidayInput(data.holidays.join('\n'));
                        }
                        if (data.aliases) setAliases(data.aliases);
                        if (data.companyAliases) setCompanyAliases(data.companyAliases);
                    } catch (e) {
                        console.error("Failed to load settings from localStorage", e);
                    }
                }
            }, []);

            // v51変更: availableLines/Stationsを2つ用意
            const availableFromLines = useMemo(() => {
                if (STATION_DATA[editingPass.fromCompany]) return Object.keys(STATION_DATA[editingPass.fromCompany]);
                return [];
            }, [editingPass.fromCompany]);

            const availableFromStations = useMemo(() => {
                if (STATION_DATA[editingPass.fromCompany] && STATION_DATA[editingPass.fromCompany][editingPass.fromLine]) {
                    return STATION_DATA[editingPass.fromCompany][editingPass.fromLine];
                }
                return [];
            }, [editingPass.fromCompany, editingPass.fromLine]);

            const availableToLines = useMemo(() => {
                if (STATION_DATA[editingPass.toCompany]) return Object.keys(STATION_DATA[editingPass.toCompany]);
                return [];
            }, [editingPass.toCompany]);

            const availableToStations = useMemo(() => {
                if (STATION_DATA[editingPass.toCompany] && STATION_DATA[editingPass.toCompany][editingPass.toLine]) {
                    return STATION_DATA[editingPass.toCompany][editingPass.toLine];
                }
                return [];
            }, [editingPass.toCompany, editingPass.toLine]);

            // 同期処理用ハンドラ
            const handleFromCompanyChange = (e) => {
                const val = e.target.value;
                setEditingPass(prev => ({
                    ...prev,
                    fromCompany: val,
                    fromLine: "",
                    fromStation: "",
                    // 自動同期
                    toCompany: val,
                    toLine: "",
                    toStation: ""
                }));
            };

            const handleFromLineChange = (e) => {
                const val = e.target.value;
                setEditingPass(prev => ({
                    ...prev,
                    fromLine: val,
                    fromStation: "",
                    // 自動同期 (toCompanyが同じ場合のみ路線も同期)
                    toLine: (prev.fromCompany === prev.toCompany) ? val : prev.toLine,
                    toStation: ""
                }));
            };

            const [tempUser, setTempUser] = useState({ name: "", passes: [] });

            const handleFileUpload = (e) => {
                const uploadedFiles = Array.from(e.target.files);
                setFiles(prev => [...prev, ...uploadedFiles]);
                uploadedFiles.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        const data = parseCSV(text, file.name);
                        setParsedData(prev => [...prev, ...data]);
                    };
                    reader.readAsText(file, "Shift_JIS"); 
                });
            };

            const updateHolidays = () => {
                const list = holidayInput.split('\n').map(s => s.trim()).filter(s => s);
                setHolidays(list);
                alert('休日設定を更新しました');
            };

            const addAlias = () => {
                if(newAlias.from && newAlias.to) {
                    setAliases([...aliases, newAlias]);
                    setNewAlias({from: "", to: "", company: ""});
                }
            };
            const removeAlias = (index) => {
                setAliases(aliases.filter((_, i) => i !== index));
            };

            const addCompanyAlias = () => {
                if(newCompanyAlias.from && newCompanyAlias.to) {
                    setCompanyAliases([...companyAliases, newCompanyAlias]);
                    setNewCompanyAlias({from: "", to: ""});
                }
            };
            const removeCompanyAlias = (index) => {
                setCompanyAliases(companyAliases.filter((_, i) => i !== index));
            };

            // [v55] 初期化処理の追加
            const handleResetSettings = () => {
                if (window.confirm("設定を初期化します。よろしいですか？\n※ブラウザに保存されたデータも消去されます。")) {
                    localStorage.removeItem('pitapa_settings');
                    setUsers([]);
                    setHolidays(INITIAL_HOLIDAYS);
                    setHolidayInput(INITIAL_HOLIDAYS.join('\n'));
                    setAliases([...generateDefaultAliases(), ...MANUAL_STATION_ALIASES]);
                    setCompanyAliases(INITIAL_COMPANY_ALIASES);
                }
            };

            const handleExportSettings = () => {
                // [v55] ブラウザへの保存処理を追加
                const settingsData = {
                    users,
                    holidays,
                    aliases,
                    companyAliases
                };
                localStorage.setItem('pitapa_settings', JSON.stringify(settingsData));

                let csvContent = "\uFEFF"; 
                csvContent += "# === ユーザー定期設定 ===\n# Type, Name, FromCompany, FromLine, FromStation, ToCompany, ToLine, ToStation\n";
                users.forEach(u => {
                    u.passes.forEach(p => {
                        // v51変更: データ構造に応じて出力
                        const fc = p.fromCompany || p.company;
                        const fl = p.fromLine || p.line;
                        const fs = p.fromStation || p.from;
                        const tc = p.toCompany || p.company;
                        const tl = p.toLine || p.line;
                        const ts = p.toStation || p.to;
                        csvContent += `USER,${u.name},${fc},${fl},${fs},${tc},${tl},${ts}\n`;
                    });
                });
                csvContent += "\n# === 休日設定 ===\n# Type, Date\n";
                holidays.forEach(h => { csvContent += `HOLIDAY,${h}\n`; });
                csvContent += "\n# === 事業者名ゆらぎ設定 ===\n# Type, From, To\n";
                companyAliases.forEach(ca => { csvContent += `COMPANY_ALIAS,${ca.from},${ca.to}\n`; });
                csvContent += "\n# === 駅名ゆらぎ設定 ===\n# Type, From, To, Company(Optional)\n";
                aliases.forEach(a => { csvContent += `ALIAS,${a.from},${a.to},${a.company || ''}\n`; });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pitapa_checker_settings.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImportSettings = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const text = ev.target.result;
                        const lines = text.split(/\r\n|\n/);
                        const newUsers = [];
                        const newHolidays = [];
                        const newAliases = [];
                        const newCompanyAliases = [];
                        
                        lines.forEach(line => {
                            if (!line.trim() || line.startsWith("#")) return;
                            const cols = line.split(',').map(c => c.trim());
                            const type = cols[0];
                            
                            if (type === 'USER') {
                                // v51変更: カラム数で新旧判定
                                let pass = {};
                                const name = cols[1];

                                if (cols.length >= 8) {
                                    // 新形式: USER, Name, FromComp, FromLine, FromSt, ToComp, ToLine, ToSt
                                    pass = {
                                        fromCompany: cols[2], fromLine: cols[3], fromStation: cols[4],
                                        toCompany: cols[5], toLine: cols[6], toStation: cols[7]
                                    };
                                } else if (cols.length >= 6) {
                                    // 旧形式: USER, Name, Comp, Line, From, To
                                    pass = {
                                        fromCompany: cols[2], fromLine: cols[3], fromStation: cols[4],
                                        toCompany: cols[2], toLine: cols[3], toStation: cols[5]
                                    };
                                }

                                if (pass.fromStation) {
                                    const existingUser = newUsers.find(u => u.name === name);
                                    if (existingUser) {
                                        existingUser.passes.push(pass);
                                    } else {
                                        newUsers.push({
                                            id: Date.now() + Math.random(),
                                            displayName: name,
                                            name: name,
                                            passes: [pass]
                                        });
                                    }
                                }
                            } else if (type === 'HOLIDAY' && cols.length >= 2) newHolidays.push(cols[1]);
                            else if (type === 'COMPANY_ALIAS' && cols.length >= 3) newCompanyAliases.push({ from: cols[1], to: cols[2] });
                            else if (type === 'ALIAS' && cols.length >= 3) newAliases.push({ from: cols[1], to: cols[2], company: cols[3] || "" });
                        });

                        if (newUsers.length > 0) setUsers(newUsers);
                        if (newHolidays.length > 0) {
                            setHolidays(newHolidays);
                            setHolidayInput(newHolidays.join('\n'));
                        }
                        if (newAliases.length > 0) setAliases(newAliases);
                        if (newCompanyAliases.length > 0) setCompanyAliases(newCompanyAliases);
                        alert('設定を読み込みました');
                    } catch (err) {
                        alert('読み込みに失敗しました: ' + err);
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleAddPass = () => {
                if (!editingPass.fromStation || !editingPass.toStation) return;
                setTempUser(prev => ({
                    ...prev,
                    passes: [...prev.passes, { ...editingPass }]
                }));
                // Reset
                setEditingPass({
                    fromCompany: "JR西日本", fromLine: "", fromStation: "",
                    toCompany: "JR西日本", toLine: "", toStation: ""
                });
            };
            const handleRemovePass = (idx) => {
                setTempUser(prev => ({
                    ...prev,
                    passes: prev.passes.filter((_, i) => i !== idx)
                }));
            };
            const handleSaveUser = () => {
                if (!tempUser.name) {
                    alert("社員名を入力してください");
                    return;
                }
                if (!tempUser.name.match(/　/)) {
                    alert("姓名の間には全角スペースを入れてください（例：山田　太郎）");
                    return;
                }
                const newUser = {
                    id: Date.now(),
                    displayName: tempUser.name,
                    name: tempUser.name,
                    passes: tempUser.passes
                };
                setUsers([...users, newUser]);
                setTempUser({ name: "", passes: [] }); 
                setEditingPass({
                    fromCompany: "JR西日本", fromLine: "", fromStation: "",
                    toCompany: "JR西日本", toLine: "", toStation: ""
                });
            };
            const removeUser = (id) => {
                setUsers(users.filter(u => u.id !== id));
            };

            const scrollToUser = (name) => {
                const element = document.getElementById(`user-card-${name}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            };

            // ... analyzedData, userSummaries, globalMonthlySummary ... (省略なしで実装)
// ==========================================
// 【修正後】analyzedData (useMemo) 一式
// ==========================================
            const analyzedData = useMemo(() => {
                return parsedData.map(record => {
                    const alerts = [];
                    let isIgnored = false;
                    let overlapInfoText = "";

                    let usagePathStr = "";
                    let passPathStrs = []; // ★変更: 複数の定期経路を保持する配列

                    const isBus = record.content.includes("バス");
                    const usageInfo = parseContent(record.content, aliases, companyAliases);
                    
                    if (isBus || !usageInfo) {
                        isIgnored = true;
                        alerts.push('bus');
                    } else {
                        if (usageInfo && !isBus) {
                            if (!usageInfo.isRandem) {
                                const fromExists = checkStationExists(usageInfo.from, usageInfo.companyPrefix, companyAliases);
                                const toExists = checkStationExists(usageInfo.to, usageInfo.companyPrefix, companyAliases);
                                if (!fromExists || !toExists) {
                                    alerts.push('unknown');
                                }
                            }
                        }
                    }

                    let company = "";
                    if (usageInfo) {
                         if (usageInfo.isRandem) {
                             company = "京福電気鉄道";
                         } else {
                             company = resolveCompanyAlias(usageInfo.companyPrefix, companyAliases);
                         }
                    }

                    if (!isIgnored || (usageInfo && !isBus)) { 
                         const holidayType = getHolidayType(record.date, holidays);
                         if (holidayType) {
                            alerts.push(holidayType);
                        }

                        const user = users.find(u => u.name === record.name);
                        
                        if (user && user.passes.length > 0 && usageInfo) {
                            const detectedOverlaps = [];
                            for (const pass of user.passes) {
                                const check = checkRouteOverlap(usageInfo, pass, companyAliases, stationGraph);
                                
                                // 事業者が共通している場合のみ経路情報が返ってくる
                                if (check.usagePathStr) usagePathStr = check.usagePathStr;
                                if (check.passPathStr) {
                                    // ★変更: 重複しないように定期経路の配列に追加
                                    if (!passPathStrs.includes(check.passPathStr)) {
                                        passPathStrs.push(check.passPathStr);
                                    }
                                }                               

                                if (check.isOverlap) {
                                    if (record.amount > 0) {
                                        if (!alerts.includes('route')) alerts.push('route');
                                        if (check.overlapText) {
                                            detectedOverlaps.push(check.overlapText);
                                        }
                                    }
                                }
                            }
                            if (detectedOverlaps.length > 0) {
                                overlapInfoText = [...new Set(detectedOverlaps)].join("\n");
                            }
                        }
                    }

                    return { ...record, alerts, isIgnored, overlapInfoText, company, usagePathStr, passPathStrs };
                });
            }, [parsedData, users, holidays, aliases, companyAliases, stationGraph]);
// ==========================================

            const userSummaries = useMemo(() => {
                const map = {};
                users.forEach(u => {
                    map[u.name] = { 
                        name: u.name, 
                        totalAmount: 0, 
                        targetAmount: 0, 
                        alertCount: 0, 
                        records: [],
                        isSubmitted: false,
                        passes: u.passes
                        // monthlySummary は削除
                    };
                });

                analyzedData.forEach(row => {
                    if (!map[row.name]) {
                        map[row.name] = { 
                            name: row.name, 
                            totalAmount: 0, 
                            targetAmount: 0, 
                            alertCount: 0, 
                            records: [],
                            isSubmitted: true,
                            isUnregistered: true
                            // monthlySummary は削除
                        };
                    }
                    
                    map[row.name].isSubmitted = true;
                    map[row.name].records.push(row);

                    // 変更点: 利用総額には対象外も含めるため、常に加算
                    map[row.name].totalAmount += row.amount;

                    // v47変更: バス（対象外）も要確認件数に含める
                    if (row.alerts.length > 0) {
                        map[row.name].alertCount++;
                    }

                    if (!row.isIgnored) {
                         if (row.alerts.includes('route')) {
                             map[row.name].targetAmount += row.amount;
                         }
                    }
                });
                return Object.values(map);
            }, [analyzedData, users]);

            // 全体集計の追加
            const globalMonthlySummary = useMemo(() => {
                const summary = {};
                analyzedData.forEach(row => {
                    // 利用なし連絡済のユーザーは除外
                    if (noUsageUsers.includes(row.name)) return;
                    // 未登録ユーザーも activeUsers に含まれるなら集計対象とする（現状のロジックに合わせる）
                    
                    // 日付文字列を解析してYYYY/MM形式に統一 (2026/1/14 -> 2026/01)
                    let monthKey = row.date.substring(0, 7); 
                    const parts = row.date.split(/[\/\-]/);
                    if (parts.length >= 2) {
                        const y = parts[0];
                        const m = parts[1].padStart(2, '0');
                        monthKey = `${y}/${m}`;
                    }

                    if (!summary[monthKey]) {
                        summary[monthKey] = { total: 0, details: {} };
                    }
                    
                    summary[monthKey].total += row.amount;
                    
                    // 集計キー：会社名があれば会社名、なければ内容（空白圧縮）
                    let key = row.company || row.content.replace(/[\s　]+/g, ' ').trim();
                    if (!key) key = "不明";

                    if (!summary[monthKey].details[key]) {
                        summary[monthKey].details[key] = 0;
                    }
                    summary[monthKey].details[key] += row.amount;
                });
                return summary;
            }, [analyzedData, noUsageUsers]);

            const missingUsers = userSummaries.filter(u => !u.isSubmitted && !u.isUnregistered && !noUsageUsers.includes(u.name));
            const unregisteredUsers = userSummaries.filter(u => u.isUnregistered && u.isSubmitted && !noUsageUsers.includes(u.name));
            const activeUsers = userSummaries.filter(u => u.isSubmitted && !noUsageUsers.includes(u.name));
            const duplicateRouteUsers = userSummaries.filter(u => u.targetAmount > 0);

            const toggleNoUsage = (name) => {
                if (noUsageUsers.includes(name)) {
                    setNoUsageUsers(noUsageUsers.filter(n => n !== name));
                } else {
                    setNoUsageUsers([...noUsageUsers, name]);
                }
            };

            // [2026-02-06] 追加: 確認OKトグル処理
            const toggleCheckedOk = (name) => {
                if (checkedOkUsers.includes(name)) {
                    setCheckedOkUsers(checkedOkUsers.filter(n => n !== name));
                } else {
                    setCheckedOkUsers([...checkedOkUsers, name]);
                }
            };

            // [2026-02-06] 追加: 「要確認（その他）」ユーザーと「確認OK」ユーザーの抽出
            // その他要確認: 重複額が0 かつ アラート数>0 かつ 未確認 かつ 利用なしリストにいない
            const otherAlertUsers = userSummaries.filter(u => 
                u.targetAmount === 0 && 
                u.alertCount > 0 && 
                !checkedOkUsers.includes(u.name) &&
                !noUsageUsers.includes(u.name)
            );

            // 確認OKリスト: 本来なら要確認だがOK済み と 重複ありだがOK済み
            const confirmedAlertUsers = userSummaries.filter(u =>
                u.alertCount > 0 &&
                checkedOkUsers.includes(u.name)
            );

            const handlePrint = () => {
                try {
                    window.focus();
                    window.print();
                } catch (e) {
                    alert("印刷機能の呼び出しに失敗しました。");
                }
            };

            const handleExportResults = () => {
                if (analyzedData.length === 0) {
                    alert("出力するデータがありません。");
                    return;
                }

                // CSVエスケープ処理
                const escape = (txt) => {
                    if (txt === null || txt === undefined) return "";
                    const stringTxt = String(txt);
                    if (stringTxt.includes(",") || stringTxt.includes("\"") || stringTxt.includes("\n")) {
                        return `"${stringTxt.replace(/"/g, '""')}"`;
                    }
                    return stringTxt;
                };

                // 集計セクションの作成
                let summaryCsv = "";
                if (Object.keys(globalMonthlySummary).length > 0) {
                    summaryCsv += "# --- 月別・事業者別集計 (全社員合計) ---\n";
                    summaryCsv += "年月,区分,金額\n";
                    Object.entries(globalMonthlySummary).sort().forEach(([month, summary]) => {
                        Object.entries(summary.details).sort((a, b) => b[1] - a[1]).forEach(([key, amount]) => {
                            summaryCsv += `${month},${escape(key)},${amount}\n`;
                        });
                        summaryCsv += `${month},【合計】,${summary.total}\n`; // 月合計行
                    });
                    summaryCsv += "\n"; // セパレータ空行
                }

                // 明細セクション
                const header = ["社員名", "日付", "時間", "内容", "金額", "備考", "状態", "重複詳細", "利用経路(システム解釈)", "定期経路(システム解釈)", "元ファイル名"];
                const rows = analyzedData.map(row => {
                    const status = [];
                    if (row.isIgnored) status.push("対象外");
                    else if (row.alerts.length === 0) status.push("OK");
                    else {
                        row.alerts.forEach(a => {
                            if (a === 'holiday') status.push("休日");
                            else if (a === 'sunday') status.push("日曜");
                            else if (a === 'saturday') status.push("土曜");
                            else if (a === 'route') status.push("定期重複");
                            else if (a === 'unknown') status.push("駅名不明");
                        });
                    }
                    
                    // v48変更: 時間が入場なし（ハイフン等で始まる）の場合、Excel対策で先頭に「'」をつける
                    // 半角ハイフン、全角ハイフン、全角マイナスなどを考慮
                    let displayTime = row.time;
                    if (displayTime && (displayTime.startsWith('-') || displayTime.startsWith('－'))) {
                        displayTime = "'" + displayTime;
                    }

// ==========================================
// 【修正後】handleExportResults の return 部分
// ==========================================
                    return [
                        escape(row.name),
                        escape(row.date),
                        escape(displayTime),
                        escape(row.content),
                        row.amount,
                        escape(row.note),
                        escape(status.join("/")),
                        escape(row.overlapInfoText || ""),
                        escape(row.usagePathStr || ""),
                        // ★変更: 配列を " / " で結合して出力
                        escape(row.passPathStrs ? row.passPathStrs.join(" / ") : ""), 
                        escape(row.fileName)
                    ].join(",");
// ==========================================
                });

                const csvContent = "\uFEFF" + summaryCsv + "# --- 明細データ ---\n" + header.join(",") + "\n" + rows.join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `pitapa_check_result_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen flex flex-col bg-gray-50 text-gray-800">
                    <header className="bg-slate-800 text-white p-4 shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto flex items-center justify-between">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <span className="bg-white text-slate-800 p-1 rounded"><Icons.Check/></span> PiTaPa Checker v57
                            </h1>
                            <nav className="flex space-x-2">
                                {[
                                    { id: 'upload', label: '1. CSV取込', icon: Icons.Upload },
                                    { id: 'users', label: '2. 定期・設定', icon: Icons.Settings },
                                    { id: 'report', label: '3. 結果確認', icon: Icons.Check }
                                ].map(tab => (
                                    <button 
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`px-4 py-2 rounded-lg flex items-center gap-2 transition ${
                                            activeTab === tab.id ? 'bg-blue-600 shadow-inner' : 'hover:bg-slate-700'
                                        }`}
                                    >
                                        <tab.icon /> {tab.label}
                                    </button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-4 ml-4">
                                <button 
                                    onClick={() => setShowHelp('history')}
                                    className="text-white hover:text-gray-300 transition"
                                    title="更新履歴"
                                >
                                    <Icons.History />
                                </button>
                                <button 
                                    onClick={() => setShowHelp('help')}
                                    className="text-white hover:text-gray-300 transition"
                                    title="ヘルプ"
                                >
                                    <Icons.Help />
                                </button>
                            </div>
                        </div>
                    </header>

                    <HelpModal isOpen={showHelp === 'help'} onClose={() => setShowHelp(false)} />
                    <HistoryModal isOpen={showHelp === 'history'} onClose={() => setShowHelp(false)} />

                    <main className="container mx-auto p-6 flex-grow print-area">
                        {activeTab === 'upload' && (
                            <div className="max-w-2xl mx-auto animate-fade-in upload-area">
                                <div className="bg-white p-10 rounded-xl shadow-sm border-2 border-dashed border-gray-300 text-center hover:border-blue-400 transition">
                                    <div className="mb-6 text-gray-400">
                                        <div className="flex justify-center mb-4"><span className="p-4 bg-gray-100 rounded-full"><Icons.Upload /></span></div>
                                        <p className="text-lg font-medium text-gray-600">CSVファイルをドラッグ＆ドロップ</p>
                                        <p className="text-sm mt-2">※ 文字化けを防ぐため自動的にShift-JISで読み込みます</p>
                                    </div>
                                    <div className="flex justify-center gap-4">
                                        <label className="cursor-pointer bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow">
                                            ファイルを選択
                                            <input type="file" multiple accept=".csv" onChange={handleFileUpload} className="hidden" />
                                        </label>
                                        <label className="cursor-pointer bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition shadow">
                                            フォルダを選択
                                            <input type="file" webkitdirectory="" multiple onChange={handleFileUpload} className="hidden" />
                                        </label>
                                    </div>
                                </div>
                                {files.length > 0 && (
                                    <div className="mt-6 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                        <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">読み込み済み ({files.length}件)</h3>
                                        <ul className="space-y-2 max-h-40 overflow-y-auto text-sm text-gray-600">
                                            {files.map((f, i) => <li key={i} className="flex items-center gap-2"><span className="w-2 h-2 bg-green-400 rounded-full"></span> {f.name}</li>)}
                                        </ul>
                                        <div className="mt-6 text-center">
                                            <button onClick={() => setActiveTab('users')} className="bg-slate-800 text-white px-8 py-3 rounded-lg hover:bg-slate-900 transition font-bold shadow-lg">
                                                次へ：定期設定を行う
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'users' && (
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 settings-area">
                                <div className="lg:col-span-2 space-y-6">
                                    <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                        <span className="font-bold text-gray-700">設定データ操作</span>
                                        <div className="flex gap-2">
                                            {/* v55: 初期化ボタンの追加 */}
                                            <button onClick={handleResetSettings} className="flex items-center gap-1 text-sm bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded border border-red-200" title="設定を初期状態に戻します">
                                                <Icons.Trash /> 初期化
                                            </button>
                                            <button onClick={handleExportSettings} className="flex items-center gap-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded border" title="CSV出力と同時にブラウザに保存されます">
                                                <Icons.Download /> 保存(CSV)
                                            </button>
                                            <label className="flex items-center gap-1 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded border cursor-pointer">
                                                <Icons.UploadFile /> 読込(CSV)
                                                <input type="file" accept=".csv" onChange={handleImportSettings} className="hidden" />
                                            </label>
                                        </div>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 user-input-form">
                                        <h2 className="text-lg font-bold mb-4 text-gray-800 border-b pb-2">新規社員・定期登録</h2>
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">社員名 (全角スペース必須・完全一致判定)</label>
                                                <input 
                                                    value={tempUser.name}
                                                    onChange={(e) => setTempUser({...tempUser, name: e.target.value})}
                                                    placeholder="例: 山田　太郎" 
                                                    className="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-200 outline-none" 
                                                />
                                            </div>
                                            
                                            {/* v51: 2カラム化した定期登録フォーム */}
                                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-sm font-bold text-gray-600">定期区間の追加</span>
                                                    <span className="text-xs text-gray-500">※左側(発)を変更すると右側(着)も連動します</span>
                                                </div>
                                                
                                                <div className="grid grid-cols-2 gap-4">
                                                    {/* 発駅側 */}
                                                    <div className="bg-white p-3 rounded border border-gray-200">
                                                        <span className="block text-xs font-bold text-gray-500 mb-2">発駅側</span>
                                                        <select 
                                                            className="w-full border p-1 rounded text-sm mb-2"
                                                            value={editingPass.fromCompany}
                                                            onChange={handleFromCompanyChange}
                                                        >
                                                            {Object.keys(STATION_DATA).map(c => <option key={c} value={c}>{c}</option>)}
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        {availableFromLines.length > 0 ? (
                                                            <select 
                                                                className="w-full border p-1 rounded text-sm mb-2"
                                                                value={editingPass.fromLine}
                                                                onChange={handleFromLineChange}
                                                            >
                                                                <option value="">路線を選択...</option>
                                                                {availableFromLines.map(l => <option key={l} value={l}>{l}</option>)}
                                                            </select>
                                                        ) : (
                                                            <input 
                                                                placeholder="路線名" 
                                                                className="w-full border p-1 rounded text-sm mb-2"
                                                                value={editingPass.fromLine}
                                                                onChange={(e) => handleFromLineChange(e)}
                                                            />
                                                        )}
                                                        <input 
                                                            list="station-list-from"
                                                            placeholder="駅名" 
                                                            className="w-full border p-1 rounded text-sm"
                                                            value={editingPass.fromStation}
                                                            onChange={(e) => setEditingPass({...editingPass, fromStation: e.target.value})}
                                                        />
                                                        <datalist id="station-list-from">
                                                            {availableFromStations.map(s => <option key={s} value={s} />)}
                                                        </datalist>
                                                    </div>

                                                    {/* 着駅側 */}
                                                    <div className="bg-white p-3 rounded border border-gray-200">
                                                        <span className="block text-xs font-bold text-gray-500 mb-2">着駅側</span>
                                                        <select 
                                                            className="w-full border p-1 rounded text-sm mb-2"
                                                            value={editingPass.toCompany}
                                                            onChange={(e) => setEditingPass({...editingPass, toCompany: e.target.value, toLine: "", toStation: ""})}
                                                        >
                                                            {Object.keys(STATION_DATA).map(c => <option key={c} value={c}>{c}</option>)}
                                                            <option value="その他">その他</option>
                                                        </select>
                                                        {availableToLines.length > 0 ? (
                                                            <select 
                                                                className="w-full border p-1 rounded text-sm mb-2"
                                                                value={editingPass.toLine}
                                                                onChange={(e) => setEditingPass({...editingPass, toLine: e.target.value, toStation: ""})}
                                                            >
                                                                <option value="">路線を選択...</option>
                                                                {availableToLines.map(l => <option key={l} value={l}>{l}</option>)}
                                                            </select>
                                                        ) : (
                                                            <input 
                                                                placeholder="路線名" 
                                                                className="w-full border p-1 rounded text-sm mb-2"
                                                                value={editingPass.toLine}
                                                                onChange={(e) => setEditingPass({...editingPass, toLine: e.target.value})}
                                                            />
                                                        )}
                                                        <input 
                                                            list="station-list-to"
                                                            placeholder="駅名" 
                                                            className="w-full border p-1 rounded text-sm"
                                                            value={editingPass.toStation}
                                                            onChange={(e) => setEditingPass({...editingPass, toStation: e.target.value})}
                                                        />
                                                        <datalist id="station-list-to">
                                                            {availableToStations.map(s => <option key={s} value={s} />)}
                                                        </datalist>
                                                    </div>
                                                </div>

                                                <button 
                                                    onClick={handleAddPass}
                                                    disabled={!editingPass.fromStation || !editingPass.toStation}
                                                    className="w-full mt-3 bg-white border border-blue-600 text-blue-600 py-2 rounded text-sm hover:bg-blue-50 disabled:opacity-50"
                                                >
                                                    + 区間リストに追加
                                                </button>
                                            </div>

                                            {tempUser.passes.length > 0 && (
                                                <div className="space-y-2">
                                                    {tempUser.passes.map((p, idx) => (
                                                        <div key={idx} className="flex justify-between items-center text-sm bg-blue-50 p-2 rounded border border-blue-100">
                                                            <div className="flex flex-col">
                                                                <span><span className="font-bold text-blue-800">[{p.fromCompany || p.company}]</span> {p.fromStation || p.from}</span>
                                                                <span className="text-gray-400 text-xs text-center">⇅</span>
                                                                <span><span className="font-bold text-blue-800">[{p.toCompany || p.company}]</span> {p.toStation || p.to}</span>
                                                            </div>
                                                            <button onClick={() => handleRemovePass(idx)} className="text-red-500 hover:text-red-700"><Icons.Trash/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            <button 
                                                onClick={handleSaveUser}
                                                className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition"
                                            >
                                                この内容で社員を登録
                                            </button>
                                        </div>
                                    </div>

                                    {/* 登録済みリスト */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h3 className="font-bold text-gray-700 mb-4">登録済み社員リスト ({users.length}名)</h3>
                                        <div className="space-y-4 max-h-96 overflow-y-auto">
                                            {users.length === 0 && <p className="text-gray-400 text-sm">登録された社員はいません。</p>}
                                            {users.map(u => (
                                                <div key={u.id} className="border rounded-lg p-4 relative hover:shadow-md transition">
                                                    <button onClick={() => removeUser(u.id)} className="absolute top-2 right-2 text-gray-400 hover:text-red-500"><Icons.Trash /></button>
                                                    <h4 className="font-bold text-lg mb-2">{u.displayName || u.name}</h4>
                                                    <ul className="text-sm space-y-1">
                                                        {u.passes.map((p, i) => (
                                                            <li key={i} className="text-gray-600 border-b last:border-0 pb-1 mb-1">
                                                                <div>[{p.fromCompany || p.company}] {p.fromStation || p.from}</div>
                                                                <div className="pl-4">⇅</div>
                                                                <div>[{p.toCompany || p.company}] {p.toStation || p.to}</div>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* 右カラム: 休日・駅名ゆらぎ設定 */}
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                        <h2 className="text-lg font-bold mb-4 text-gray-800">休日設定</h2>
                                        <p className="text-xs text-gray-500 mb-2">YYYY-MM-DD形式で入力。土日は自動判定。</p>
                                        <textarea 
                                            className="w-full h-32 border p-2 rounded font-mono text-xs focus:ring-2 focus:ring-blue-200 outline-none"
                                            value={holidayInput}
                                            onChange={(e) => setHolidayInput(e.target.value)}
                                        ></textarea>
                                        <button onClick={updateHolidays} className="mt-2 w-full bg-gray-600 text-white py-2 rounded text-sm hover:bg-gray-700">
                                            設定を保存
                                        </button>
                                    </div>

                                    {/* 事業者名ゆらぎ */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 alias-input-form">
                                        <h2 className="text-lg font-bold mb-4 text-gray-800">事業者名変換設定</h2>
                                        <div className="flex gap-2 mb-2 items-center">
                                            <input 
                                                className="w-1/2 border p-1 rounded text-sm" 
                                                placeholder="元 (例: 大地下鉄)" 
                                                value={newCompanyAlias.from}
                                                onChange={(e) => setNewCompanyAlias({...newCompanyAlias, from: e.target.value})}
                                            />
                                            <input 
                                                className="w-1/2 border p-1 rounded text-sm" 
                                                placeholder="変換後 (例: 大阪メトロ)" 
                                                value={newCompanyAlias.to}
                                                onChange={(e) => setNewCompanyAlias({...newCompanyAlias, to: e.target.value})}
                                            />
                                            <button onClick={addCompanyAlias} className="bg-blue-600 text-white p-2 rounded"><Icons.Plus /></button>
                                        </div>
                                        <div className="max-h-32 overflow-y-auto border-t pt-2">
                                            <table className="w-full text-xs">
                                                <thead><tr className="text-left text-gray-500"><th>元</th><th>変換後</th><th></th></tr></thead>
                                                <tbody>
                                                    {companyAliases.map((a, i) => (
                                                        <tr key={i} className="border-b">
                                                            <td className="py-1">{a.from}</td>
                                                            <td className="py-1">{a.to}</td>
                                                            <td className="text-right"><button onClick={() => removeCompanyAlias(i)} className="text-red-500">×</button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    {/* 駅名ゆらぎ */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 alias-input-form">
                                        <h2 className="text-lg font-bold mb-4 text-gray-800">駅名変換設定（ゆらぎ）</h2>
                                        <p className="text-xs text-gray-500 mb-2">※全路線の全駅名（正式名称、市・駅省略形、接頭辞省略形）は自動登録済みです。</p>
                                        <div className="flex gap-2 mb-2 items-center">
                                            <div className="flex-1 space-y-1">
                                                <input 
                                                    className="w-full border p-1 rounded text-sm" 
                                                    placeholder="略称 (例: 天茶)" 
                                                    value={newAlias.from}
                                                    onChange={(e) => setNewAlias({...newAlias, from: e.target.value})}
                                                />
                                                <input 
                                                    className="w-full border p-1 rounded text-sm" 
                                                    placeholder="正式 (例: 天下茶屋)" 
                                                    value={newAlias.to}
                                                    onChange={(e) => setNewAlias({...newAlias, to: e.target.value})}
                                                />
                                                <input 
                                                    className="w-full border p-1 rounded text-sm" 
                                                    placeholder="対象事業者 (任意, 例: 阪急)" 
                                                    value={newAlias.company}
                                                    onChange={(e) => setNewAlias({...newAlias, company: e.target.value})}
                                                />
                                            </div>
                                            <button onClick={addAlias} className="bg-blue-600 text-white p-2 rounded h-full"><Icons.Plus /></button>
                                        </div>
                                        <div className="max-h-64 overflow-y-auto border-t pt-2">
                                            <table className="w-full text-xs">
                                                <thead><tr className="text-left text-gray-500"><th>略称</th><th>正式</th><th>事業者</th><th></th></tr></thead>
                                                <tbody>
                                                    {aliases.filter(a => MANUAL_STATION_ALIASES.some(ma => ma.from === a.from) || !a.company).map((a, i) => (
                                                        <tr key={i} className="border-b">
                                                            <td className="py-1">{a.from}</td>
                                                            <td className="py-1">{a.to}</td>
                                                            <td className="py-1 text-gray-400">{a.company || '-'}</td>
                                                            <td className="text-right">
                                                                <button onClick={() => removeAlias(i)} className="text-red-500 hover:text-red-700">×</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                    <tr><td colSpan="4" className="text-center text-gray-400 py-2">...他 自動生成分多数...</td></tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'report' && (
                            <div className="space-y-8 animate-fade-in">
                                <div className="flex justify-end items-center gap-2 no-print info-panel">
                                    <span className="text-xs text-red-500 bg-red-50 px-2 py-1 rounded border border-red-200">
                                        ※ファイルをPCに保存し、ブラウザで開いてから印刷してください
                                    </span>
                                    <button 
                                        type="button"
                                        onClick={handleExportResults}
                                        className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow transition"
                                    >
                                        <Icons.Download /> 結果CSV出力
                                    </button>
                                    <button 
                                        type="button"
                                        onClick={handlePrint}
                                        className="flex items-center gap-2 bg-slate-700 text-white px-4 py-2 rounded-lg hover:bg-slate-800 shadow transition"
                                    >
                                        <Icons.Printer /> 印刷プレビュー
                                    </button>
                                </div>

                                {/* 全社集計表示 (新規追加) */}
                                {Object.keys(globalMonthlySummary).length > 0 && (
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 page-break">
                                        <h3 className="font-bold text-gray-700 mb-4 border-b pb-2">月別・事業者別集計 (全社員合計)</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {Object.entries(globalMonthlySummary).sort().map(([month, summary]) => (
                                                <div key={month} className="border rounded-lg p-3 bg-gray-50 text-sm break-inside-avoid">
                                                    <div className="flex justify-between items-center border-b pb-1 mb-2">
                                                        <span className="font-bold text-lg">{month}</span>
                                                        <span className="font-bold text-blue-700 text-lg">計 ¥{summary.total.toLocaleString()}</span>
                                                    </div>
                                                    <ul className="space-y-1">
                                                        {Object.entries(summary.details).sort((a, b) => b[1] - a[1]).map(([key, amount]) => (
                                                            <li key={key} className="flex justify-between text-gray-600 border-b border-dashed border-gray-300 py-1 last:border-0">
                                                                <span className="truncate pr-2">{key}</span>
                                                                <span className="font-mono">¥{amount.toLocaleString()}</span>
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 no-print mb-4">
                                    {missingUsers.length > 0 && (
                                        <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-red-800 mb-2">未提出 ({missingUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {missingUsers.map((u, i) => (
                                                    <button 
                                                        key={i} 
                                                        onClick={() => toggleNoUsage(u.name)}
                                                        className="px-3 py-1 bg-white border border-red-200 text-red-700 rounded-full text-sm font-medium hover:bg-red-100"
                                                        title="クリックで「利用なし」に登録"
                                                    >
                                                        {u.name} <span className="text-xs text-gray-400 ml-1">登録</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {unregisteredUsers.length > 0 && (
                                        <div className="bg-gray-100 border border-gray-300 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-gray-700 mb-2">社員未登録 ({unregisteredUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {unregisteredUsers.map((u, i) => (
                                                    <button 
                                                        key={i} 
                                                        onClick={() => scrollToUser(u.name)}
                                                        className="px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded-full text-sm font-medium hover:bg-gray-200"
                                                        title="クリックで詳細へ移動"
                                                    >
                                                        {u.name}
                                                    </button>
                                                ))}
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">※CSVに実績がありますが社員登録がありません</p>
                                        </div>
                                    )}
                                    {duplicateRouteUsers.length > 0 && (
                                        <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-yellow-800 mb-2">定期区間重複あり ({duplicateRouteUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {duplicateRouteUsers.map((u, i) => (
                                                    <span 
                                                        key={i} 
                                                        onClick={() => scrollToUser(u.name)}
                                                        className="px-3 py-1 bg-white border border-yellow-200 text-yellow-700 rounded-full text-sm font-medium cursor-pointer hover:bg-yellow-100 transition"
                                                    >
                                                        {u.name}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {/* [2026-02-06] 追加: その他要確認リスト */}
                                    {otherAlertUsers.length > 0 && (
                                        <div className="bg-orange-50 border border-orange-200 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-orange-800 mb-2">要確認（その他） ({otherAlertUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {otherAlertUsers.map((u, i) => (
                                                    <DoubleClickButton
                                                        key={i} 
                                                        onClick={() => scrollToUser(u.name)}
                                                        onDoubleClick={() => toggleCheckedOk(u.name)}
                                                        className="px-3 py-1 bg-white border border-orange-200 text-orange-700 rounded-full text-sm font-medium cursor-pointer hover:bg-orange-100 transition select-none"
                                                        title="クリックで詳細へ移動、ダブルクリックで「確認OK」へ"
                                                    >
                                                        {u.name}
                                                    </DoubleClickButton>
                                                ))}
                                            </div>
                                            <p className="text-xs text-orange-600 mt-2">※クリックで詳細へ移動、ダブルクリックで確認済みに移動</p>
                                        </div>
                                    )}
                                    {/* [2026-02-06] 追加: 確認OKリスト */}
                                    {confirmedAlertUsers.length > 0 && (
                                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-blue-800 mb-2">確認OK ({confirmedAlertUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {confirmedAlertUsers.map((u, i) => (
                                                    <button
                                                        key={i} 
                                                        onClick={() => toggleCheckedOk(u.name)}
                                                        className="px-3 py-1 bg-white border border-blue-200 text-blue-700 rounded-full text-sm font-medium cursor-pointer hover:bg-blue-100 transition"
                                                        title="クリックで「要確認」に戻す"
                                                    >
                                                        {u.name} <span className="text-xs text-gray-400 ml-1">戻す</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    
                                    {noUsageUsers.length > 0 && (
                                        <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                                            <h3 className="text-lg font-bold text-green-800 mb-2">利用なし連絡済 ({noUsageUsers.length}名)</h3>
                                            <div className="flex flex-wrap gap-2">
                                                {noUsageUsers.map((name, i) => (
                                                    <button 
                                                        key={i} 
                                                        onClick={() => toggleNoUsage(name)}
                                                        className="px-3 py-1 bg-white border border-green-200 text-green-700 rounded-full text-sm font-medium hover:bg-green-100"
                                                        title="クリックで「未提出」に戻す"
                                                    >
                                                        {name} <span className="text-xs text-gray-400 ml-1">解除</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* 印刷用ヘッダー要約 (印刷時のみ表示、画面では上記コンポーネントで表示) */}
                                <div className="print-area hidden">
                                    {(missingUsers.length > 0) && (
                                        <div className="print-summary-box">
                                            <span className="print-summary-title">【未提出】</span>
                                            {missingUsers.map(u => u.name).join(", ")}
                                        </div>
                                    )}
                                    {(unregisteredUsers.length > 0) && (
                                        <div className="print-summary-box">
                                            <span className="print-summary-title">【社員未登録】</span>
                                            {unregisteredUsers.map(u => u.name).join(", ")}
                                        </div>
                                    )}
                                    {(duplicateRouteUsers.length > 0) && (
                                        <div className="print-summary-box">
                                            <span className="print-summary-title">【定期区間重複あり】</span>
                                            {duplicateRouteUsers.map(u => u.name).join(", ")}
                                        </div>
                                    )}
                                    {(otherAlertUsers.length > 0) && (
                                        <div className="print-summary-box">
                                            <span className="print-summary-title">【要確認（その他）】</span>
                                            {otherAlertUsers.map(u => u.name).join(", ")}
                                        </div>
                                    )}
                                    {(noUsageUsers.length > 0) && (
                                        <div className="print-summary-box">
                                            <span className="print-summary-title">【利用なし連絡済】</span>
                                            {noUsageUsers.join(", ")}
                                        </div>
                                    )}
                                </div>

                                {activeUsers.length === 0 && missingUsers.length === 0 && noUsageUsers.length === 0 ? (
                                    <div className="text-center text-gray-400 py-20 bg-white rounded-xl border-dashed border-2 border-gray-200 no-print">
                                        <p className="text-xl mb-2">データが表示されませんか？</p>
                                        <p className="text-sm">CSVファイルを読み込み、社員登録を行ってください。</p>
                                        <button onClick={() => setActiveTab('upload')} className="mt-4 text-blue-600 underline">アップロード画面へ</button>
                                    </div>
                                ) : (
                                    activeUsers.map((user, idx) => (
                                        <div key={idx} id={`user-card-${user.name}`} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden page-break print-break-inside-avoid result-card">
                                            <div className="bg-gray-50 px-6 py-4 border-b flex flex-wrap gap-4 justify-between items-center result-header">
                                                <div>
                                                    <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                                        {user.name} 様
                                                        {user.isUnregistered && <span className="text-xs bg-gray-600 text-white px-2 py-0.5 rounded">未登録</span>}
                                                        {noUsageUsers.includes(user.name) && <span className="text-xs bg-green-600 text-white px-2 py-0.5 rounded">利用なし連絡済</span>}
                                                        {/* [2026-02-06] 追加: 確認OKバッジ */}
                                                        {checkedOkUsers.includes(user.name) && <span className="text-xs bg-blue-600 text-white px-2 py-0.5 rounded">確認OK</span>}
                                                    </h3>
                                                    {user.passes && user.passes.length > 0 && (
                                                        <div className="pass-info mt-1">
                                                            <div className="font-bold mb-1">定期区間: </div>
                                                            <div className="space-y-1">
                                                                {user.passes.map((p, i) => {
                                                                    // 1. ノードキーの生成
                                                                    const pFromComp = p.fromCompany || p.company;
                                                                    const pFromSt   = p.fromStation || p.from;
                                                                    const pToComp   = p.toCompany   || p.company;
                                                                    const pToSt     = p.toStation   || p.to;

                                                                    const passStartNode = `${pFromComp}:${pFromSt}`;
                                                                    const passEndNode   = `${pToComp}:${pToSt}`;
                                                                    
                                                                    // 2. 経路の動的計算と文字列化
                                                                    let pathStr = "経路の計算ができません（駅名または接続を確認してください）";
                                                                    if (stationGraph[passStartNode] && stationGraph[passEndNode]) {
                                                                        const passPath = findShortestPath([passStartNode], [passEndNode], stationGraph);
                                                                        if (passPath) {
                                                                            pathStr = passPath.map(node => node.split(':')[1]).join(' → ');
                                                                        }
                                                                    }

                                                                    // 3. アコーディオンUIの描画
                                                                    return (
                                                                            <details key={i} className="group cursor-pointer block ml-2">
                                                                            <summary className="outline-none hover:text-blue-600 transition list-none [&::-webkit-details-marker]:hidden flex items-center gap-1 select-none w-max">
                                                                                {/* ↓ 三角アイコンに no-print を追加 */}
                                                                                <span className="text-gray-400 group-open:rotate-90 transition-transform text-[10px] no-print">▶</span>
                                                                                <span className="border-b border-dashed border-gray-400 group-hover:border-blue-400" style={{ borderBottomColor: 'print' ? 'transparent' : '' }}>
                                                                                    [{pFromComp}] {pFromSt} ⇔ [{pToComp}] {pToSt}
                                                                                </span>
                                                                            </summary>
                                                                            <div className="pl-3 ml-1.5 mt-1.5 mb-2 text-gray-500 border-l-2 border-blue-300 whitespace-normal break-words text-[11px] leading-relaxed bg-white p-2 rounded shadow-sm max-w-3xl cursor-text no-print">
                                                                                {pathStr}
                                                                            </div>
                                                                        </details>
                                                                    );
                                                                })}
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="flex gap-4 items-center">
                                                    {!noUsageUsers.includes(user.name) && (
                                                        <>
                                                            <div className="text-right summary-info">
                                                                <span className="text-gray-500">定期重複額: </span>
                                                                <span className="font-bold text-red-600">¥{user.targetAmount.toLocaleString()}</span>
                                                            </div>
                                                            <div className="text-right border-l pl-4 summary-info">
                                                                <span className="text-gray-500">利用総額(対象外込): </span>
                                                                <span className="font-bold text-slate-700">¥{user.totalAmount.toLocaleString()}</span>
                                                            </div>
                                                            {user.alertCount > 0 ? (
                                                                <span className={`ml-2 px-4 py-2 rounded-lg font-bold border flex items-center gap-2 ${checkedOkUsers.includes(user.name) ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-red-50 text-red-600 border-red-100'}`}>
                                                                    {!checkedOkUsers.includes(user.name) && <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse no-print"></span>}
                                                                    {checkedOkUsers.includes(user.name) ? '確認済' : '要確認'} {user.alertCount}件
                                                                </span>
                                                            ) : (
                                                                <span className="ml-2 bg-green-50 text-green-600 px-4 py-2 rounded-lg font-bold border border-green-100">
                                                                    問題なし
                                                                </span>
                                                            )}
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            {/* 個別集計表は削除 */}

                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left whitespace-nowrap">
                                                    <thead className="bg-gray-100 text-gray-600">
                                                        <tr>
                                                            <th className="px-6 py-3 w-32">状態</th>
                                                            <th className="px-6 py-3 w-32">日付</th>
                                                            <th className="px-6 py-3 w-32">時間</th>
                                                            <th className="px-6 py-3">内容</th>
                                                            <th className="px-6 py-3 text-right">金額</th>
                                                            <th className="px-6 py-3 text-gray-400">備考</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-gray-100">
                                                        {noUsageUsers.includes(user.name) ? (
                                                            <tr>
                                                                <td colSpan="6" className="px-6 py-8 text-center text-green-600 font-bold bg-green-50">
                                                                    利用なし（連絡済み）
                                                                    <button onClick={() => toggleNoUsage(user.name)} className="ml-4 text-xs text-gray-400 underline no-print">解除</button>
                                                                </td>
                                                            </tr>
                                                        ) : user.records.length === 0 ? (
                                                            <tr>
                                                                <td colSpan="6" className="px-6 py-8 text-center text-gray-400">
                                                                    利用履歴なし
                                                                </td>
                                                            </tr>

                                                        ) : (
                                                            user.records.map((row, rIdx) => (
                                                                <tr key={rIdx} className={`hover:bg-gray-50 transition ${row.isIgnored ? 'opacity-50 bg-gray-50' : ''} ${row.alerts.length > 0 ? (checkedOkUsers.includes(user.name) ? 'bg-blue-50' : 'bg-red-50 hover:bg-red-100') : ''}`}>
                                                                    <td className="px-6 py-3">
                                                                        {row.alerts.length > 0 ? row.alerts.map(a => <AlertBadge key={a} type={a} />) : (row.isIgnored ? '-' : <span className="text-green-500 font-bold">OK</span>)}
                                                                    </td>
                                                                    <td className="px-6 py-3 font-mono text-gray-600">{row.date}</td>
                                                                    <td className="px-6 py-3 font-mono text-gray-600">{row.time}</td>
                                                                    <td className="px-6 py-3 font-medium text-gray-800">
                                                                        {row.content.replace(/[\s　]+/g, ' ')}
                                                                    </td>
                                                                    <td className="px-6 py-3 text-right font-mono">¥{row.amount.toLocaleString()}</td>
                                                                    <td className="px-6 py-3 max-w-sm text-gray-500 whitespace-normal break-words">
                                                                        {row.overlapInfoText && (
                                                                            <div className="block text-xs text-red-600 font-bold mb-1">
                                                                                <span className="mr-1">重複:</span>
                                                                                {row.overlapInfoText.split('\n').map((text, idx) => {
                                                                                    const match = text.match(/^(?:(\(.+\))\s+)?(.+?)⇔(.+)$/);
                                                                                    if (match) {
                                                                                        const lineName = match[1] ? match[1] + " " : "";
                                                                                        const st1 = match[2];
                                                                                        const st2 = match[3];
                                                                                        const url = `https://transit.yahoo.co.jp/search/result?from=${encodeURIComponent(st1)}&to=${encodeURIComponent(st2)}`;
                                                                                        return (
                                                                                            <div key={idx}>
                                                                                                {lineName}
                                                                                                <a href={url} target="_blank" rel="noopener noreferrer" className="underline hover:text-red-800" title="Yahoo!路線情報で確認">
                                                                                                    {st1}⇔{st2}
                                                                                                </a>
                                                                                            </div>
                                                                                        );
                                                                                    }
                                                                                    return <div key={idx}>{text}</div>;
                                                                                })}
                                                                            </div>
                                                                        )}
                                                                        <div>{row.note}</div>
                                                                        
                                                                        {/* 経路詳細アコーディオン */}
                                                                        {(row.usagePathStr || (row.passPathStrs && row.passPathStrs.length > 0)) && (
                                                                            <details className="mt-2 text-xs border border-gray-200 rounded p-1.5 bg-white cursor-pointer no-print group">
                                                                                <summary className="font-bold text-blue-600 outline-none select-none group-open:mb-2 group-open:border-b group-open:pb-1">🔍 経路詳細を確認</summary>
                                                                                <div className="pl-2 border-l-2 border-blue-200 space-y-1.5">
                                                                                    {row.usagePathStr && (
                                                                                        <div>
                                                                                            <span className="inline-block bg-gray-600 text-white px-1 py-0.5 rounded text-[10px] mr-1">利用</span> 
                                                                                            {row.usagePathStr}
                                                                                        </div>
                                                                                    )}
                                                                                    {/* ★変更: 定期経路の配列をループしてすべて表示 */}
                                                                                    {row.passPathStrs && row.passPathStrs.map((pStr, pIdx) => (
                                                                                        <div key={pIdx}>
                                                                                            <span className="inline-block bg-blue-600 text-white px-1 py-0.5 rounded text-[10px] mr-1">定期</span> 
                                                                                            {pStr}
                                                                                        </div>
                                                                                    ))}
                                                                                </div>
                                                                            </details>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            ))
                                                        )}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
